name: æ›´æ–°EPGèŠ‚ç›®å•è‡³cnb

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  schedule:
  # åŒ—äº¬æ—¶é—´å‡Œæ™¨2ç‚¹ = UTCæ—¶é—´å‰ä¸€å¤©18ç‚¹
  - cron: '15 16,18,20,22,0,2,4,6,8,10,12,14 * * *'

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
    - name: ä¸‹è½½EPGèŠ‚ç›®å•
      run: |
        wget -q https://epg.112114.xyz/pp.xml -O 1day112114_epg.xml

    - name: Sync to CNB Repository
      run: |
          echo "ğŸ”„ å¼€å§‹åŒæ­¥åˆ° CNB.cool"
          
          # å˜é‡è®¾ç½®
          CNB_USER="tyrian9905"
          CNB_REPO="work"
          CNB_TOKEN="${{ secrets.CNB_TOKEN }}"
          
          # è·å–å½“å‰æ—¶é—´
          BEIJING_TIME=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')
          
          echo "ç›®æ ‡ä»“åº“: https://cnb.cool/${CNB_USER}/${CNB_REPO}"
          echo "åŒæ­¥æ—¶é—´: ${BEIJING_TIME}"
          
          # å…‹éš†CNBä»“åº“
          echo "ğŸ“¥ å…‹éš†ç›®æ ‡ä»“åº“..."
          git clone --depth=1 "https://${CNB_TOKEN}@cnb.cool/${CNB_USER}/${CNB_REPO}.git" ${CNB_REPO}
          
          # è¿›å…¥ç›®å½•
          cd ${CNB_REPO}
        
          # å¤åˆ¶æ–‡ä»¶
          cp ../1day112114_epg.xml ./
                    
          git add -A
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git diff --cached --quiet; then
            echo "â„¹ï¸ æ²¡æœ‰æ£€æµ‹åˆ°å˜æ›´ï¼Œè·³è¿‡æäº¤"
          else
            # æäº¤
            echo "ğŸ’¾ æäº¤æ›´æ”¹..."
            git commit -m "ğŸ”„ å…¨é‡åŒæ­¥ ${BEIJING_TIME}
            
            åŒæ­¥è¯¦æƒ…:
            - æºä»“åº“: ${{ github.repository }}
            - æäº¤å“ˆå¸Œ: ${{ github.sha }}
            - è§¦å‘è€…: ${{ github.actor }}
            - æ—¶é—´: ${BEIJING_TIME}
            - è¿è¡ŒID: ${{ github.run_id }}
            "
            
            # æ¨é€
            echo "ğŸš€ æ¨é€åˆ°CNB..."
            git push origin HEAD:main --force
            
            echo "âœ… åŒæ­¥å®Œæˆï¼"
            echo "ğŸ”— ä»“åº“åœ°å€: https://cnb.cool/${CNB_USER}/${CNB_REPO}"
          fi
