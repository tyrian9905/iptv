name: æ›´æ–°EPGèŠ‚ç›®å•è‡³cnb

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  schedule:
  # åŒ—äº¬æ—¶é—´å‡Œæ™¨2ç‚¹ = UTCæ—¶é—´å‰ä¸€å¤©18ç‚¹
  - cron: '15 16,18,20,22,0,2,4,6,8,10,12,14 * * *'

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
    - name: ä¸‹è½½EPGèŠ‚ç›®å•
      run: |
        wget -q https://epg.112114.xyz/pp.xml -O 1day112114_epg.xml

    - name: Configure Git for CNB
      run: |
          # é‡è¦ï¼šå¿…é¡»è®¾ç½®CNB.coolè¦æ±‚çš„ç”¨æˆ·ä¿¡æ¯
          git config --global user.name "cnb.bksHmtpvgGA"
          git config --global user.email "mHca2rdBDfCrNrmhbqRCRB+cnb.bksHmtpvgGA@noreply.cnb.cool"
          
          echo "âœ… Gité…ç½®å®Œæˆ"
          git config --global --list | grep user
          
    - name: Sync to work.git repository
      env:
          CNB_TOKEN: ${{ secrets.CNB_TOKEN }}
      run: |
          echo "ğŸ”„ å¼€å§‹åŒæ­¥åˆ° CNB.cool work.git ä»“åº“..."
          
          # é‡è¦ï¼šç°åœ¨ä½¿ç”¨ work.git è€Œä¸æ˜¯ IPTV.git
          CNB_URL="https://${CNB_TOKEN}@cnb.cool/tyrian9905/work"
          
          # åŒ—äº¬æ—¶é—´
          BEIJING_TIME=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')
          
          echo "================================="
          echo "åŒæ­¥é…ç½®:"
          echo "ç›®æ ‡ä»“åº“: ${CNB_URL}"
          echo "åŒæ­¥æ—¶é—´: ${BEIJING_TIME}"
          echo "æºä»“åº“: ${{ github.repository }}"
          echo "è§¦å‘æ–¹å¼: ${{ github.event_name }}"
          echo "================================="
          
          # å…‹éš†CNBä»“åº“
          echo "ğŸ“¥ å…‹éš†ç›®æ ‡ä»“åº“..."
          git clone --depth=1 "${CNB_URL}" cnb-work
          
          # è¿›å…¥ç›®å½•
          cd cnb-work
          
          # æ˜¾ç¤ºå½“å‰ç›®å½•å†…å®¹
          echo "ç›®æ ‡ä»“åº“å†…å®¹:"
          ls -la

          # å¤åˆ¶æ–°æ–‡ä»¶
          echo "ğŸ“„ å¤åˆ¶EPGæ–‡ä»¶..."
          cp -f "../1day112114_epg.xml" ./
          
          # æ£€æŸ¥æ–‡ä»¶å·®å¼‚
          echo "ğŸ” æ£€æŸ¥æ–‡ä»¶å·®å¼‚..."
          if [ -f "${BACKUP_NAME}" ]; then
            echo "æ–°æ—§æ–‡ä»¶å¯¹æ¯”:"
            diff -u "${BACKUP_NAME}" "1day112114_epg.xml" | head -20 || echo "æ–‡ä»¶ç›¸åŒæˆ–æ— æ³•æ¯”è¾ƒ"
          fi
          
          # æ·»åŠ åˆ°Git
          git add 1day112114_epg.xml
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git diff --cached --quiet; then
            echo "â„¹ï¸ æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´ï¼Œè·³è¿‡æäº¤"
            echo "å½“å‰æ–‡ä»¶å“ˆå¸Œ: $(md5sum 1day112114_epg.xml | cut -d' ' -f1)"
          else
            echo "âœ… æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´ï¼Œå‡†å¤‡æäº¤..."
            
            # æäº¤ä¿¡æ¯
            COMMIT_MSG="ğŸ“º æ›´æ–°EPGèŠ‚ç›®å• ${BEIJING_TIME}"
            
            # æäº¤
            git commit -m "${COMMIT_MSG}"
            
            # æ¨é€
            echo "ğŸš€ æ¨é€åˆ°CNB..."
            git push origin HEAD:main
            
            echo "ğŸ‰ åŒæ­¥æˆåŠŸï¼"
            echo "========================="
            echo "åŒæ­¥å®Œæˆ:"
            echo "æ—¶é—´: ${BEIJING_TIME}"
            echo "ä»“åº“: https://cnb.cool/tyrian9905/work"
            echo "æ–‡ä»¶: 1day112114_epg.xml"
            echo "å¤§å°: $(wc -l < 1day112114_epg.xml) è¡Œ"
            echo "========================="
          fi
