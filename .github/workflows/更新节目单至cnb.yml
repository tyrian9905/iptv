name: æ›´æ–°EPGèŠ‚ç›®å•è‡³cnb

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  schedule:
  # åŒ—äº¬æ—¶é—´å‡Œæ™¨2ç‚¹ = UTCæ—¶é—´å‰ä¸€å¤©18ç‚¹
  - cron: '15 16,18,20,22,0,2,4,6,8,10,12,14 * * *'

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
    - name: ä¸‹è½½EPGèŠ‚ç›®å•
      run: |
        wget -q https://epg.112114.xyz/pp.xml -O 1day112114_epg.xml

- name: æ¨é€åˆ°cnb
  run: |
    # è®¾ç½®å˜é‡
    USER="tyrian9905"
    REPO="work"  # â† é‡è¦ï¼šæ”¹ä¸º IPTV
    TOKEN="${{ secrets.CNB_TOKEN }}"
    
    # è·å–åŒ—äº¬æ—¶é—´
    export TZ='Asia/Shanghai'
    BEIJING_TIME=$(date '+%Y-%m-%d %H:%M:%S')
    
    echo "ğŸ• å¼€å§‹æ—¶é—´: ${BEIJING_TIME}"
    echo "ğŸ“¦ åŒæ­¥åˆ° CNB.cool ä»“åº“: ${REPO}"
    
    # é…ç½®Gitå…¨å±€è®¾ç½®
    git config --global user.name "GitHub Actions"
    git config --global user.email "actions@github.com"
    
    # å…‹éš†ä»“åº“ï¼ˆæ–¹å¼2ï¼šåˆ†æ”¯è¿ç§»ï¼‰
    echo "ğŸ“¥ å…‹éš†ä»“åº“..."
    git clone --depth=1 "https://${TOKEN}@cnb.cool/${USER}/${REPO}.git" cnb-repo
    
    # è¿›å…¥ä»“åº“
    cd cnb-repo
    
    # æ£€æŸ¥å¹¶å¤åˆ¶æ–‡ä»¶
    if [ -f "../1day112114_epg.xml" ]; then
      echo "ğŸ“„ å¤åˆ¶æ–‡ä»¶..."
      cp -f "../1day112114_epg.xml" ./
      echo "æ–‡ä»¶ä¿¡æ¯:"
      ls -lh 1day112114_epg.xml
      echo "è¡Œæ•°: $(wc -l < 1day112114_epg.xml)"
    else
      echo "âŒ é”™è¯¯ï¼šæ‰¾ä¸åˆ° ../1day112114_epg.xml"
      echo "å½“å‰ç›®å½•: $(pwd)"
      echo "ä¸Šçº§ç›®å½•å†…å®¹:"
      ls -la ../
      exit 1
    fi
    
    # é…ç½®å½“å‰ä»“åº“çš„ç”¨æˆ·ä¿¡æ¯ï¼ˆå¯é€‰ï¼Œå‚è€ƒæ–¹å¼3ï¼‰
    git config --local user.name "cnb.bksHmtpvgGA"
    git config --local user.email "mHca2rdBDfCrNrmhbqRCRB+cnb.bksHmtpvgGA@noreply.cnb.cool"
    
    # æ·»åŠ æ–‡ä»¶
    echo "ğŸ“ æ·»åŠ æ–‡ä»¶åˆ°Git..."
    git add 1day112114_epg.xml
    
    # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
    if git diff --cached --quiet; then
      echo "â„¹ï¸ æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜åŒ–ï¼Œè·³è¿‡æäº¤"
    else
      # æäº¤
      echo "ğŸ’¾ æäº¤æ›´æ”¹..."
      git commit -m "è‡ªåŠ¨åŒæ­¥èŠ‚ç›®å•EPG ${BEIJING_TIME}"
      
      # æ¨é€ï¼ˆæ–¹å¼2ï¼‰
      echo "ğŸš€ æ¨é€åˆ°è¿œç¨‹ä»“åº“..."
      git push origin HEAD:main  # æ¨é€åˆ°mainåˆ†æ”¯
      
      echo "ğŸ‰ èŠ‚ç›®å•EPGåŒæ­¥æˆåŠŸï¼"
      echo "ğŸ“… åŒæ­¥æ—¶é—´: ${BEIJING_TIME}"
    fi
    
    # æ˜¾ç¤ºè¿œç¨‹ä¿¡æ¯
    echo "ğŸ”— è¿œç¨‹ä»“åº“ä¿¡æ¯:"
    git remote -v
