name: 更新EPG节目单至cnb

on:
  workflow_dispatch:  # 手动触发
  schedule:
  # 北京时间凌晨2点 = UTC时间前一天18点
  - cron: '15 16,18,20,22,0,2,4,6,8,10,12,14 * * *'

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
    - name: 下载EPG节目单
      run: |
        wget -q https://epg.112114.xyz/pp.xml -O 1day112114_epg.xml

    - name: Sync to CNB Repository
      run: |
          echo "🔄 开始同步到 CNB.cool"
          
          # 变量设置
          CNB_USER="tyrian9905"
          CNB_REPO="IPTV"
          CNB_TOKEN="${{ secrets.CNB_TOKEN }}"
          
          # 获取当前时间
          BEIJING_TIME=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')
          
          echo "目标仓库: https://cnb.cool/${CNB_USER}/${CNB_REPO}"
          echo "同步时间: ${BEIJING_TIME}"
          
          # 克隆CNB仓库
          echo "📥 克隆目标仓库..."
          git clone --depth=1 "https://${CNB_TOKEN}@cnb.cool/${CNB_USER}/${CNB_REPO}.git" cnb-sync
          
          # 进入目录
          cd cnb-sync
          
          # 移除所有现有文件（保留.git目录）
          echo "🧹 清理目标仓库..."
          find . -maxdepth 1 ! -name '.git' ! -name '.' ! -name '..' -exec rm -rf {} +
          
          # 从源仓库复制所有文件
          echo "📄 复制文件..."
          cp -rf ../* . 2>/dev/null || true
          cp -rf ../.* . 2>/dev/null || true
          
          # 移除不需要的文件
          rm -rf .github/workflows/sync-to-cnb.yml 2>/dev/null || true
          
          # 添加所有文件
          echo "📝 添加文件到Git..."
          git add -A
          
          # 检查是否有变更
          if git diff --cached --quiet; then
            echo "ℹ️ 没有检测到变更，跳过提交"
          else
            # 提交
            echo "💾 提交更改..."
            git commit -m "🔄 全量同步 ${BEIJING_TIME}
            
            同步详情:
            - 源仓库: ${{ github.repository }}
            - 提交哈希: ${{ github.sha }}
            - 触发者: ${{ github.actor }}
            - 时间: ${BEIJING_TIME}
            - 运行ID: ${{ github.run_id }}
            "
            
            # 推送
            echo "🚀 推送到CNB..."
            git push origin HEAD:main --force
            
            echo "✅ 同步完成！"
            echo "🔗 仓库地址: https://cnb.cool/${CNB_USER}/${CNB_REPO}"
          fi
