name: 更新DNS过滤文件

on:
  workflow_dispatch:  # 手动触发
  schedule:
  # 北京时间凌晨2点 = UTC时间前一天18点
  - cron: '40 16,0,8 * * *'

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
    - name: 下载DNS过滤文件
      run: |
        wget -q https://raw.githubusercontent.com/217heidai/adblockfilters/main/rules/adblockfilterslite.txt -O 217heidai_adblockfilterslite.txt
        wget -q https://raw.githubusercontent.com/217heidai/adblockfilters/main/rules/adblockdnsmasqlite.txt -O 217heidai广告规则.txt
        wget -q https://raw.githubusercontent.com/TG-Twilight/AWAvenue-Ads-Rule/main/Filters/AWAvenue-Ads-Rule-Dnsmasq.conf -O 秋风广告规则.txt
        wget -q https://raw.githubusercontent.com/217heidai/adblockfilters/main/rules/adblockdnsmasqlite.txt -O anti-ad广告规则.txt

    - name: 推送到Gitee
      run: |
        # 配置Git
        git config --global user.name "Auto Sync"
        git config --global user.email "auto@sync.com"
        USER="tyrian9905"
        REPO="iptv"
        
        export TZ='Asia/Shanghai'
        BEIJING_TIME=$(date '+%Y-%m-%d %H:%M:%S')
        
        # 克隆仓库
        git clone https://oauth2:${{ secrets.GITEE_TOKEN }}@gitee.com/${USER}/${REPO}.git
        
        cd ${REPO}
        
        # 确保目录存在
        mkdir -p adblock
        
        # 复制所有广告规则文件
        cp ../*.txt ./dnsblock/ 2>/dev/null || true
        
        # 添加dnsblock目录下所有文件
        git add adblock/
        
        # 检查是否有变更
        if ! git diff --cached --quiet; then
          git commit -m "自动同步DNS过滤文件 ${BEIJING_TIME}"
          git push origin master
          echo "✅ 文件已同步到Gitee！"
        else
          echo "⚠️ 没有文件变更，跳过提交"
        fi
