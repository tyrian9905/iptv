name: Process IPTV Playlist (No Push)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'

jobs:
  process:
    runs-on: ubuntu-latest
    outputs:
      file_url: ${{ steps.output-url.outputs.file_url }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Process File
        run: |
          # 创建处理脚本
          cat > process_simple.sh << 'EOF'
          #!/bin/bash
          echo "处理IPTV文件..."
          
          # 下载
          URL="https://raw.githubusercontent.com/Healer-sys/Home/refs/heads/main/iptv/gx.m3u"
          curl -s "$URL" -o input.m3u
          
          # 简单处理：在#EXTINF行添加tvg-id
          awk '{
            if ($0 ~ /^#EXTINF:/ && $0 !~ /tvg-id=/) {
              # 提取频道名
              split($0, parts, ",")
              if (length(parts) > 1) {
                name = parts[length(parts)]
                gsub(/[^a-zA-Z0-9\u4e00-\u9fff\s]/, "", name)
                gsub(/\s+/, "_", name)
                tvg_id = tolower(name)
                
                # 重新构建
                prefix = ""
                for (i = 1; i < length(parts); i++) {
                  if (i > 1) prefix = prefix ","
                  prefix = prefix parts[i]
                }
                print prefix " tvg-id=\"" tvg_id "\"," parts[length(parts)]
                next
              }
            }
            print
          }' input.m3u > output.m3u
          
          mkdir -p iptv
          mv output.m3u iptv/gx_processed.m3u
          echo "✅ 文件已生成: iptv/gx_processed.m3u"
          EOF
          
          chmod +x process_simple.sh
          ./process_simple.sh
          
      - name: Upload as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: iptv-playlist
          path: iptv/
          retention-days: 1
          
      - name: Output URL
        id: output-url
        run: |
          echo "file_url=https://raw.githubusercontent.com/${{ github.repository }}/main/iptv/gx_processed.m3u" >> $GITHUB_OUTPUT
