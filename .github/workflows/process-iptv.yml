name: Process IPTV Playlist

on:
  workflow_dispatch:  # ä»…æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤©UTC 2ç‚¹

jobs:
  process:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout with token
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          
      - name: Setup Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
      - name: Download and process M3U
        run: |
          # ä¸‹è½½åŸå§‹æ–‡ä»¶
          echo "æ­£åœ¨ä¸‹è½½åŸå§‹æ–‡ä»¶..."
          curl -s -L "https://raw.githubusercontent.com/Healer-sys/Home/refs/heads/main/iptv/gx.m3u" -o original.m3u
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä¸‹è½½æˆåŠŸ
          if [ ! -s original.m3u ]; then
            echo "é”™è¯¯ï¼šæ–‡ä»¶ä¸‹è½½å¤±è´¥æˆ–ä¸ºç©º"
            exit 1
          fi
          
          echo "åŸå§‹æ–‡ä»¶ä¸‹è½½æˆåŠŸï¼Œè¡Œæ•°: $(wc -l < original.m3u)"
          
          # å¤„ç†æ–‡ä»¶
          echo "å¼€å§‹å¤„ç†æ–‡ä»¶..."
          mkdir -p iptv
          
          # ä½¿ç”¨awkå¤„ç†ï¼Œæ›´ç®€å•
          awk '
          BEGIN {
            print "å¼€å§‹å¤„ç†M3Uæ–‡ä»¶..."
          }
          /^#EXTINF:/ {
            line = $0
            if (line !~ /tvg-id=/) {
              # æå–é¢‘é“åç§°
              split(line, parts, ",")
              if (length(parts) >= 2) {
                channel_name = parts[length(parts)]
                gsub(/^[[:space:]]+|[[:space:]]+$/, "", channel_name)
                
                # ç”Ÿæˆtvg-id
                tvg_id = channel_name
                gsub(/[^a-zA-Z0-9\u4e00-\u9fff\s_-]/, "", tvg_id)
                gsub(/[[:space:]]+/, "_", tvg_id)
                tvg_id = tolower(tvg_id)
                
                # é‡å»ºè¡Œ
                new_line = ""
                for (i = 1; i < length(parts); i++) {
                  if (i > 1) new_line = new_line ","
                  new_line = new_line parts[i]
                }
                new_line = new_line " tvg-id=\"" tvg_id "\"," channel_name
                print new_line
                next
              }
            }
          }
          { print }
          ' original.m3u > iptv/gx_with_tvgid.m3u
          
          echo "å¤„ç†å®Œæˆï¼"
          echo "å¤„ç†åçš„æ–‡ä»¶è¡Œæ•°: $(wc -l < iptv/gx_with_tvgid.m3u)"
          
      - name: Commit and Push
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
          if [ -z "$(git status --porcelain iptv/)" ]; then
            echo "æ²¡æœ‰å˜åŒ–éœ€è¦æäº¤"
          else
            echo "æ£€æµ‹åˆ°å˜åŒ–ï¼Œå‡†å¤‡æäº¤..."
            git add iptv/
            git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°IPTVåˆ—è¡¨ $(date +'%Y-%m-%d %H:%M:%S')"
            git push
            echo "âœ… æäº¤æˆåŠŸ"
          fi
