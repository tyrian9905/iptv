name: æ›´æ–°é€šç”¨M3U

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  schedule:
  # åŒ—äº¬æ—¶é—´å‡Œæ™¨2ç‚¹ = UTCæ—¶é—´å‰ä¸€å¤©18ç‚¹
  - cron: '20 17,19,21,23,1,3,5,7,9,11,13,15 * * *'

jobs:
  process-tv-channels:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests pyyaml
        
    - name: Create processing script
      run: |
        cat << 'EOF' > process_tv.py
        import re
        import requests
        from urllib.parse import quote

        SOURCE_URL = "https://raw.githubusercontent.com/jn950/live/main/tv/pllive.txt"
        LOGO_BASE_URL = "https://gitee.com/tyrian9905/iptv/raw/master/tvlogo/"
        OUTPUT_FILE = "é€šç”¨.m3u"
        EPG_URL = "https://gitee.com/tyrian9905/iptv/raw/master/1day112114_epg.xml"

        def process_tvname(tvname):
            # è½¬æ¢ä¸ºå¤§å†™å¹¶å»é™¤å‰åç©ºæ ¼
            tvname = tvname.upper().strip()
            
            # æ£€æŸ¥4K/8K
            if "4K" in tvname or "8K" in tvname:
                return None
                
            # å»é™¤ä¸éœ€è¦çš„å­—ç¬¦
            for pattern in [" ", "-", "HD", "SD", "é«˜æ¸…", "æ ‡æ¸…", "è¶…æ¸…"]:
                tvname = tvname.replace(pattern, "")
                
            # å¤„ç†CCTVç‰¹æ®Šé¢‘é“
            if "CCTV" in tvname:
                if "+" in tvname or "PLUS" in tvname:
                    return "CCTV5+"
                elif "3D" in tvname:
                    return "CCTV3D"
                elif "ç¾æ´²" in tvname or "AME" in tvname:
                    return "CCTV4ç¾æ´²"
                elif "æ¬§æ´²" in tvname or "EUO" in tvname:
                    return "CCTV4æ¬§æ´²"
                elif "10" in tvname:
                    return "CCTV10"
                else:
                    match = re.search(r"(CCTV\d{1,2})", tvname)
                    if match:
                        return match.group(1)
            return tvname

        # ä¸‹è½½ç›´æ’­æº
        response = requests.get(SOURCE_URL)
        response.raise_for_status()
        lines = response.text.splitlines()[3:]  # è·³è¿‡å‰ä¸‰è¡Œ

        with open(OUTPUT_FILE, "w", encoding="utf-8") as f:
            f.write(f'#EXTM3U x-tvg-url="{EPG_URL}"\n')
            
            current_group = ""
            for line in lines:
                line = line.strip()
                if not line:
                    continue
                    
                if "#genre#" in line:
                    current_group = line.split(",")[0].strip()
                    continue
                    
                if line.startswith("#"):
                    continue
                    
                parts = line.split(",", 1)
                if len(parts) != 2:
                    continue
                    
                channel_name, url = parts
                channel_name = channel_name.strip()
                url = url.strip()
                
                processed_name = process_tvname(channel_name)
                if not processed_name:
                    continue
                    
                encoded_name = quote(processed_name.replace(" ", "-").replace("/", ""))
                logo_url = f"{LOGO_BASE_URL}{encoded_name}.png"
                
                f.write(f'#EXTINF:-1 tvg-id="{processed_name}" tvg-name="{processed_name}" tvg-logo="{logo_url}" group-title="{current_group}",{processed_name}\n')
                f.write(f"{url}\n")
        EOF
        
    - name: Run processing script
      run: python process_tv.py
      
    - name: æ¨é€åˆ°Gitee
      run: |
        # é…ç½®Git
        git config --global user.name "Auto Sync"
        git config --global user.email "auto@sync.com"
        USER="tyrian9905"    # â† ç”¨æˆ·å
        REPO="iptv"        # â† ä»“åº“å
        
        export TZ='Asia/Shanghai'
        # è·å–åŒ—äº¬æ—¶é—´
        BEIJING_TIME=$(date '+%Y-%m-%d %H:%M:%S')
        
        # å…‹éš†ä»“åº“
        git clone https://oauth2:${{ secrets.GITEE_TOKEN }}@gitee.com/${USER}/${REPO}.git
        
        # è¿›å…¥ä»“åº“å¹¶æ›´æ–°æ–‡ä»¶
        cd ${REPO}
        
        # å¤åˆ¶æ–‡ä»¶
        cp ../é€šç”¨.m3u ./
        
        # æäº¤å¹¶æ¨é€
        git add é€šç”¨.m3u
        git commit -m "è‡ªåŠ¨åŒæ­¥ ${BEIJING_TIME}"
        git push origin master
        
        echo "ğŸ‰ èŠ‚ç›®m3uæ›´æ–°æˆåŠŸï¼"
