name: æ›´æ–°é€šç”¨M3U

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  schedule:
  # åŒ—äº¬æ—¶é—´å‡Œæ™¨2ç‚¹ = UTCæ—¶é—´å‰ä¸€å¤©18ç‚¹
  - cron: '20 1,9 * * *'

jobs:
  process:
    runs-on: ubuntu-latest
    timeout-minutes: 3
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests pyyaml
        
    - name: Process Channels
      run: |
        cat <<'EOF'>complete_processor.py
        import re, requests
        from urllib.parse import quote

        class TVProcessor:
            __slots__ = ('config', 'skip_pattern', 'cctv_names')
            
            def __init__(self):
                self.config = {
                    'source': "https://raw.githubusercontent.com/jn950/live/main/tv/pllive.txt",
                    'logo': "https://raw.githubusercontent.com/fanmingming/live/main/tv/",
                    'epg': "https://gitee.com/tyrian9905/iptv/raw/master/1day112114_epg.xml"
                }
                self.skip_pattern = re.compile(r'å«è§†([1-9]|1[0-2])|å«è§†F|4K|8K', re.IGNORECASE)
                # CCTVæ ‡å‡†åç§°æ˜ å°„
                self.cctv_names = {
                    'CCTV1': 'CCTV-1ç»¼åˆ',
                    'CCTV2': 'CCTV-2è´¢ç»',
                    'CCTV3': 'CCTV-3ç»¼è‰º',
                    'CCTV4': 'CCTV-4ä¸­æ–‡å›½é™…',
                    'CCTV5': 'CCTV-5ä½“è‚²',
                    'CCTV5+': 'CCTV-5+ä½“è‚²èµ›äº‹',
                    'CCTV6': 'CCTV-6ç”µå½±',
                    'CCTV7': 'CCTV-7å›½é˜²å†›äº‹',
                    'CCTV8': 'CCTV-8ç”µè§†å‰§',
                    'CCTV9': 'CCTV-9çºªå½•',
                    'CCTV10': 'CCTV-10ç§‘æ•™',
                    'CCTV11': 'CCTV-11æˆæ›²',
                    'CCTV12': 'CCTV-12ç¤¾ä¼šä¸æ³•',
                    'CCTV13': 'CCTV-13æ–°é—»',
                    'CCTV14': 'CCTV-14å°‘å„¿',
                    'CCTV15': 'CCTV-15éŸ³ä¹',
                    'CCTV16': 'CCTV-16å¥¥æ—åŒ¹å…‹',
                    'CCTV17': 'CCTV-17å†œä¸šå†œæ‘'
                }

            def process(self):
                with (
                    open('MY9åŸç‰ˆ.m3u', 'w', encoding='utf-8') as f_orig,
                    open('MY9åˆ†èŠ‚ç›®.m3u', 'w', encoding='utf-8') as f_cat,
                    open('MY9æ— åˆ†ç»„.m3u', 'w', encoding='utf-8') as f_flat
                ):
                    # å†™å…¥æ–‡ä»¶å¤´
                    header = f"#EXTM3U x-tvg-url=\"{self.config['epg']}\"\n"
                    f_orig.write(header)
                    f_cat.write(header)
                    f_flat.write(header)

                    content = requests.get(self.config['source']).text.splitlines()
                    
                    # è·³è¿‡å‰ä¸¤è¡Œè¯´æ˜
                    for line in content[2:]:
                        line = line.strip()
                        if not line or '#genre#' in line or line.startswith('#'):
                            continue
                        
                        if ',' not in line:
                            continue
                        
                        name, url = line.split(',', 1)
                        name, url = name.strip(), url.strip()
                        
                        # MY9åŸç‰ˆï¼šä½¿ç”¨åŸå§‹åç§°ï¼ˆä¸åšä»»ä½•å¤„ç†ï¼‰
                        self._write_entry(f_orig, name, "", name, url)
                        
                        # è·³è¿‡éœ€è¦è¿‡æ»¤çš„é¢‘é“ï¼ˆä»…ç”¨äºåˆ†èŠ‚ç›®å’Œæ— åˆ†ç»„ç‰ˆæœ¬ï¼‰
                        if self.skip_pattern.search(name):
                            continue
                        
                        # MY9åˆ†èŠ‚ç›®å’ŒMY9æ— åˆ†ç»„ï¼šå¤„ç†ç”µè§†å°åç§°
                        processed_name = self._normalize_name(name)
                        final_name, display_name, is_cctv = self._process_channel(processed_name, name)
                        
                        # MY9åˆ†èŠ‚ç›®ï¼šåˆ†ç±»ç‰ˆ
                        self._write_entry(f_cat, final_name, "å¤®è§†" if is_cctv else "å«è§†", display_name, url)
                        # MY9æ— åˆ†ç»„ï¼šç»Ÿä¸€åˆ†ç»„
                        self._write_entry(f_flat, final_name, "MY9", display_name, url)

            def _normalize_name(self, name):
                """æ‰§è¡Œæ‰€æœ‰æŒ‡å®šçš„æ›¿æ¢æ“ä½œ"""
                name = name.upper().strip()
                replacements = [
                    (' ', ''),
                    ('-', ''),
                    ('HD', ''),
                    ('SD', ''),
                    ('é«˜æ¸…', ''),
                    ('æ ‡æ¸…', ''),
                    ('è¶…æ¸…', '')
                ]
                for old, new in replacements:
                    name = name.replace(old, new)
                return name

            def _process_channel(self, processed_name, original_name):
                """å¤„ç†æ ‡å‡†åŒ–åçš„åç§°ï¼Œè¿”å›(tvg_name, display_name, is_cctv)"""
                # æ£€æŸ¥æ˜¯å¦æ˜¯CCTVé¢‘é“ï¼ˆåŒ…å«æ‰€æœ‰CCTVç¼–å·ï¼‰
                cctv_match = re.search(r'CCTV(\d{1,2}|\+)|CCTV(3D|ç¾æ´²|æ¬§æ´²)', processed_name, re.IGNORECASE)
                if cctv_match:
                    # ç‰¹æ®ŠCCTVé¢‘é“å¤„ç†
                    if '+' in processed_name or 'PLUS' in processed_name:
                        return 'CCTV5+', 'CCTV-5+ä½“è‚²èµ›äº‹', True
                    if '3D' in processed_name:
                        return 'CCTV3D', 'CCTV3D', True
                    if 'ç¾æ´²' in processed_name or 'AME' in processed_name:
                        return 'CCTV4ç¾æ´²', 'CCTV4ç¾æ´²', True
                    if 'æ¬§æ´²' in processed_name or 'EUO' in processed_name:
                        return 'CCTV4æ¬§æ´²', 'CCTV4æ¬§æ´²', True
                    
                    # æŸ¥æ‰¾æ ‡å‡†CCTVç¼–å·
                    for short, full in self.cctv_names.items():
                        if short.replace('-', '').replace('+', '') in processed_name.replace('-', '').replace('+', ''):
                            return short, full, True
                
                # CETV/CGTNå¤„ç†
                if 'CETV' in processed_name or 'CGTN' in processed_name:
                    return processed_name, original_name, True
                    
                # å«è§†å¤„ç†
                return processed_name, original_name, False

            def _write_entry(self, f, tvg_name, group, display_name, url):
                """å†™å…¥æ ‡å‡†æ ¼å¼æ¡ç›®"""
                safe_name = quote(tvg_name.replace("/", ""))
                f.write(
                    f'#EXTINF:-1 tvg-name="{tvg_name}" '
                    f'tvg-logo="{self.config["logo"]}{safe_name}.png" '
                    f'group-title="{group}",{display_name}\n'
                    f"{url}\n"
                )

        if __name__ == '__main__':
            TVProcessor().process()
        EOF

        python complete_processor.py
      
    - name: æ¨é€åˆ°Gitee
      run: |
        # é…ç½®Git
        git config --global user.name "Auto Sync"
        git config --global user.email "auto@sync.com"
        USER="tyrian9905"    # â† ç”¨æˆ·å
        REPO="iptv"        # â† ä»“åº“å
        
        export TZ='Asia/Shanghai'
        # è·å–åŒ—äº¬æ—¶é—´
        BEIJING_TIME=$(date '+%Y-%m-%d %H:%M:%S')
        
        # å…‹éš†ä»“åº“
        git clone https://oauth2:${{ secrets.GITEE_TOKEN }}@gitee.com/${USER}/${REPO}.git
        
        # è¿›å…¥ä»“åº“å¹¶æ›´æ–°æ–‡ä»¶
        cd ${REPO}
        
        # å¤åˆ¶æ–‡ä»¶
        cp ../MY9åŸç‰ˆ.m3u ./
        cp ../MY9åˆ†èŠ‚ç›®.m3u ./
        cp ../MY9æ— åˆ†ç»„.m3u ./
        
        # æäº¤å¹¶æ¨é€
        git add MY9åŸç‰ˆ.m3u MY9åˆ†èŠ‚ç›®.m3u MY9æ— åˆ†ç»„.m3u
        git commit -m "è‡ªåŠ¨åŒæ­¥ ${BEIJING_TIME}"
        git push origin master
        
        echo "ğŸ‰ èŠ‚ç›®m3uæ›´æ–°æˆåŠŸï¼"
