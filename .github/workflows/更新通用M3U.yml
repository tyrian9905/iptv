name: æ›´æ–°é€šç”¨M3U

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  schedule:
  # åŒ—äº¬æ—¶é—´å‡Œæ™¨2ç‚¹ = UTCæ—¶é—´å‰ä¸€å¤©18ç‚¹
  - cron: '20 1,9 * * *'

jobs:
  process:
    runs-on: ubuntu-latest
    timeout-minutes: 3
    
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: Process Channels
      run: |
        cat <<'EOF'>optimized_processor.py
        import re, requests
        from urllib.parse import quote

        class TVProcessor:
            __slots__ = ('config', 'skip_pattern')
            
            def __init__(self):
                self.config = {
                    'source': "https://raw.githubusercontent.com/jn950/live/main/tv/pllive.txt",
                    'logo': "https://raw.githubusercontent.com/fanmingming/live/main/tv/",
                    'epg': "https://gitee.com/tyrian9905/iptv/raw/master/1day112114_epg.xml",
                    'cctv_map': {
                        r'\+|PLUS': 'CCTV5+',
                        '3D': 'CCTV3D',
                        'ç¾æ´²|AME': 'CCTV4ç¾æ´²',
                        'æ¬§æ´²|EUO': 'CCTV4æ¬§æ´²',
                        '10': 'CCTV10'
                    }
                }
                # ç¼–è¯‘é«˜æ•ˆè·³è¿‡æ¨¡å¼ (å«è§†1-12 + å«è§†F + 4K/8K)
                self.skip_pattern = re.compile(
                    r'å«è§†([1-9]|1[0-2])|å«è§†F|4K|8K', 
                    re.IGNORECASE
                )

            def process(self):
                with (
                    open('MY9åŸç‰ˆ.m3u', 'w', encoding='utf-8') as f_orig,
                    open('MY9åˆ†èŠ‚ç›®.m3u', 'w', encoding='utf-8') as f_cat,
                    open('MY9æ— åˆ†ç»„.m3u', 'w', encoding='utf-8') as f_flat
                ):
                    # å…±äº«æ–‡ä»¶å¤´
                    header = f"#EXTM3U x-tvg-url=\"{self.config['epg']}\"\n"
                    f_orig.write(header)
                    f_cat.write(header)
                    f_flat.write(header)

                    current_group = ""
                    for line in requests.get(self.config['source']).text.splitlines()[3:]:
                        line = line.strip()
                        if not line:
                            continue
                        
                        # å¤„ç†åˆ†ç»„è¡Œ
                        if line.startswith('#genre#'):
                            current_group = line.split(',')[0]
                            continue
                        elif line.startswith('#'):
                            continue
                        
                        # åˆ†å‰²é¢‘é“ä¿¡æ¯
                        parts = line.split(',', 1)
                        if len(parts) != 2:
                            continue
                        name, url = parts[0].strip(), parts[1].strip()
                        
                        # åŸç‰ˆå†™å…¥ (ä¿ç•™æ‰€æœ‰å†…å®¹)
                        self._write_entry(f_orig, name, current_group, url)
                        
                        # æ£€æŸ¥è·³è¿‡è§„åˆ™ (ä½¿ç”¨é¢„ç¼–è¯‘æ­£åˆ™)
                        if self.skip_pattern.search(name):
                            continue
                        
                        # æ ‡å‡†åŒ–åç§°å¹¶åˆ†ç±»
                        norm_name = self._normalize_name(name)
                        category = self._determine_category(norm_name)
                        
                        # åˆ†ç±»ç‰ˆå†™å…¥
                        self._write_entry(f_cat, norm_name, category, url)
                        # æ— åˆ†ç»„ç‰ˆå†™å…¥
                        self._write_entry(f_flat, norm_name, "IPTV", url)

            def _normalize_name(self, name):
                """æ ‡å‡†åŒ–é¢‘é“åç§°"""
                name = name.upper()
                # ç§»é™¤ç©ºæ ¼/ç¬¦å·/ç”»è´¨æ ‡è¯†
                return re.sub(
                    r'[ -]|HD|SD|é«˜æ¸…|æ ‡æ¸…|è¶…æ¸…', 
                    '', 
                    name
                )

            def _determine_category(self, name):
                """ç¡®å®šé¢‘é“åˆ†ç±»"""
                # CCTVç‰¹æ®Šå¤„ç†
                if 'CCTV' in name:
                    for pattern, new_name in self.config['cctv_map'].items():
                        if re.search(pattern, name):
                            return 'å¤®è§†'
                    return 'å¤®è§†'
                
                # å…¶ä»–åˆ†ç±»åˆ¤æ–­
                if ('CETV' in name or 'CGTN' in name or
                    'å«è§†' in name or
                    'å¹¿ä¸œç æ±Ÿ' in name or
                    'å±±ä¸œæ•™è‚²' in name or
                    å‡¤å‡°é¦™æ¸¯' in name or
                    'å‡¤å‡°ä¸­æ–‡' in name or
                    'å‡¤å‡°èµ„è®¯' in name:
                    return 'å«è§†'
                return 'å…¶ä»–'

            def _write_entry(self, f, name, group, url):
                """é€šç”¨å†™å…¥æ–¹æ³•"""
                safe_name = quote(name.replace("/", ""))
                f.write(
                    f'#EXTINF:-1 tvg-id="{name}" '
                    f'tvg-name="{name}" '
                    f'tvg-logo="{self.config["logo"]}{safe_name}.png" '
                    f'group-title="{group}",{name}\n'
                    f"{url}\n"
                )

        if __name__ == '__main__':
            TVProcessor().process()
        EOF

        python optimized_processor.py
      
    - name: æ¨é€åˆ°Gitee
      run: |
        # é…ç½®Git
        git config --global user.name "Auto Sync"
        git config --global user.email "auto@sync.com"
        USER="tyrian9905"    # â† ç”¨æˆ·å
        REPO="iptv"        # â† ä»“åº“å
        
        export TZ='Asia/Shanghai'
        # è·å–åŒ—äº¬æ—¶é—´
        BEIJING_TIME=$(date '+%Y-%m-%d %H:%M:%S')
        
        # å…‹éš†ä»“åº“
        git clone https://oauth2:${{ secrets.GITEE_TOKEN }}@gitee.com/${USER}/${REPO}.git
        
        # è¿›å…¥ä»“åº“å¹¶æ›´æ–°æ–‡ä»¶
        cd ${REPO}
        
        # å¤åˆ¶æ–‡ä»¶
        cp ../MY9åŸç‰ˆ.m3u ./
        cp ../MY9åˆ†èŠ‚ç›®.m3u ./
        cp ../MY9æ— åˆ†ç»„.m3u ./
        
        # æäº¤å¹¶æ¨é€
        git add é€šç”¨.m3u MY9åˆ†èŠ‚ç›®.m3u MY9æ— åˆ†ç»„.m3u
        git commit -m "è‡ªåŠ¨åŒæ­¥ ${BEIJING_TIME}"
        git push origin master
        
        echo "ğŸ‰ èŠ‚ç›®m3uæ›´æ–°æˆåŠŸï¼"
