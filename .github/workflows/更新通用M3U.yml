name: æ›´æ–°é€šç”¨M3U

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  schedule:
  # åŒ—äº¬æ—¶é—´å‡Œæ™¨2ç‚¹ = UTCæ—¶é—´å‰ä¸€å¤©18ç‚¹
  - cron: '0 2,10 * * *'

jobs:
  process:
    runs-on: ubuntu-latest
    timeout-minutes: 3
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests
        
    - name: Process TV Channels
      run: |
        cat <<'EOF'>tv_processor.py
        import re
        import requests
        from urllib.parse import quote

        # ==================== é…ç½®å‚æ•° ====================
        SOURCE_URL = "https://raw.githubusercontent.com/jn950/live/refs/heads/main/tv/pllive.txt"
        LOGO_BASE_URL = "https://gitee.com/tyrian9905/iptv/raw/master/tvlogo/"
        EPG_URL = "https://gitee.com/tyrian9905/iptv/raw/master/1day112114_epg.xml"
        GROUP_FLAT = "MY9"

        # ==================== CCTVæ˜¾ç¤ºåç§°æ˜ å°„ ====================
        CCTV_DISPLAY_NAMES = {
            "CCTV1": "CCTV-1 ç»¼åˆ",
            "CCTV2": "CCTV-2 è´¢ç»",
            "CCTV3": "CCTV-3 ç»¼è‰º",
            "CCTV4": "CCTV-4 ä¸­æ–‡å›½é™…",
            "CCTV5": "CCTV-5 ä½“è‚²",
            "CCTV6": "CCTV-6 ç”µå½±",
            "CCTV7": "CCTV-7 å›½é˜²å†›äº‹",
            "CCTV8": "CCTV-8 ç”µè§†å‰§",
            "CCTV9": "CCTV-9 çºªå½•",
            "CCTV11": "CCTV-11 æˆæ›²",
            "CCTV12": "CCTV-12 ç¤¾ä¼šä¸æ³•",
            "CCTV13": "CCTV-13 æ–°é—»",
            "CCTV14": "CCTV-14 å°‘å„¿",
            "CCTV15": "CCTV-15 éŸ³ä¹",
            "CCTV16": "CCTV-16 å¥¥æ—åŒ¹å…‹",
            "CCTV17": "CCTV-17 å†œä¸šå†œæ‘"
        }

        def normalize_tvname(tvname):
            """æ­¥éª¤80: æ ‡å‡†åŒ–tvname"""
            tvname = tvname.upper()
            characters_to_remove = [' ', '-', 'FHD', 'HD', 'SD', 'é«˜æ¸…', 'æ ‡æ¸…', 'è¶…æ¸…']
            for char in characters_to_remove:
                tvname = tvname.replace(char, '')
            return tvname

        def process_special_channels(tvname):
            """æ­¥éª¤100.1-100.3: å¤„ç†ç‰¹æ®Šé¢‘é“åç§°"""
            # æ­¥éª¤100.1: è¥¿è—å«è§†è—è¯­
            if "è¥¿è—å«è§†è—è¯­" in tvname:
                return "è—è¯­å«è§†", "è—è¯­å«è§†"
            
            # æ­¥éª¤100.2: ç¬¬ä¸€è´¢ç»
            if tvname == "ç¬¬ä¸€è´¢ç»":
                return "ä¸œæ–¹è´¢ç»", "ä¸œæ–¹è´¢ç»"
            
            # æ­¥éª¤100.3: ä¸­å›½äº¤é€šé¢‘é“
            if tvname == "ä¸­å›½äº¤é€šé¢‘é“":
                return "ä¸­å›½äº¤é€š", "ä¸­å›½äº¤é€š"
            
            return tvname, tvname

        def process_cgtn_channels(tvname):
            """æ­¥éª¤100.5: å¤„ç†CGTNé¢‘é“"""
            # æ­¥éª¤100.5.1: CGTNè‹±è¯­
            if "CGTNè‹±è¯­" in tvname:
                return "CGTN", "CGTN"
            
            # æ­¥éª¤100.5.2: é˜¿æ‹‰ä¼¯è¯­
            if "é˜¿æ‹‰ä¼¯è¯­" in tvname:
                return "CGTNé˜¿è¯­", "CGTNé˜¿æ‹‰ä¼¯è¯­"
            
            # æ­¥éª¤100.5.3: è¥¿ç­ç‰™è¯­
            if "è¥¿ç­ç‰™è¯­" in tvname:
                return "CGTNè¥¿è¯­", "CGTNè¥¿ç­ç‰™è¯­"
            
            return tvname, tvname

        def process_cctv_channels(tvname):
            """æ­¥éª¤100.7: å¤„ç†CCTVé¢‘é“"""
            # æ­¥éª¤100.7.1: 3Dé¢‘é“
            if "3D" in tvname:
                return "CCTV3D", "CCTV 3D"
            
            # æ­¥éª¤100.7.2: ç¾æ´²é¢‘é“
            if "ç¾æ´²" in tvname or "AME" in tvname:
                return "CCTV4ç¾æ´²", "CCTV-4 ç¾æ´²"
            
            # æ­¥éª¤100.7.3: æ¬§æ´²é¢‘é“
            if "æ¬§æ´²" in tvname or "EUO" in tvname:
                return "CCTV4æ¬§æ´²", "CCTV-4 æ¬§æ´²"
            
            # æ­¥éª¤100.7.4: 5+é¢‘é“
            if "+" in tvname or "PLUS" in tvname:
                return "CCTV5+", "CCTV-5+ ä½“è‚²èµ›äº‹"
            
            # æ­¥éª¤100.7.5: CCTV10
            if "10" in tvname:
                return "CCTV10", "CCTV-10 ç§‘æ•™"
            
            # æ­¥éª¤100.7.6: å…¶ä»–CCTVæ•°å­—é¢‘é“
            modified_name = tvname.replace("0", "") + "HD"
            pattern = r"(CCTV\d{1,2})[^\d]"
            match = re.search(pattern, modified_name)
            
            if match:
                cctv_num = match.group(1)
                display_name = CCTV_DISPLAY_NAMES.get(cctv_num, cctv_num)
                return cctv_num, display_name
            
            return tvname, tvname

        def build_logo_url(tvname):
            """æ„å»ºlogo URL"""
            safe_tvname = quote(tvname.replace("/", ""))
            return f"{LOGO_BASE_URL}{safe_tvname}.png"

        def write_channel_entry(file_obj, tvname, group_name, display_name, url, logo_url):
            """å†™å…¥M3Ué¢‘é“æ¡ç›®"""
            entry = f'#EXTINF:-1 tvg-name="{tvname}" '
            entry += f'tvg-logo="{logo_url}" '
            entry += f'group-title="{group_name}",{display_name}\n'
            entry += f"{url}\n"
            file_obj.write(entry)

        def process_line(line, current_group_orig, current_group_cat):
            """å¤„ç†å•è¡Œæ•°æ®"""
            # æ­¥éª¤40: è·³è¿‡ç©ºç™½è¡Œ
            line = line.strip()
            if not line:
                return current_group_orig, current_group_cat, None
            
            # æ­¥éª¤50: åˆ†å‰²è¡Œå†…å®¹
            parts = line.split(',', 1)
            if len(parts) < 2:
                return current_group_orig, current_group_cat, None
            
            str1, str2 = parts[0].strip(), parts[1].strip()
            
            # æ­¥éª¤60: å¤„ç†str2çš„ä¸åŒæƒ…å†µ
            if not str2:
                # æƒ…å†µ1: str2ä¸ºç©ºï¼Œè·³è¿‡
                return current_group_orig, current_group_cat, None
            elif str2 == "#genre#":
                # æƒ…å†µ2: åˆ†ç»„è¡Œ
                return str1, current_group_cat, None
            else:
                # æƒ…å†µ3: é¢‘é“è¡Œ
                tvname = str1
                tvlink = str2
                
                # æ­¥éª¤70: è·³è¿‡4K/8Ké¢‘é“å’Œç‰¹å®šå«è§†é¢‘é“
                if "4K" in tvname or "8K" in tvname or re.search(r"å«è§†[\d]", tvname):
                    return current_group_orig, current_group_cat, None
                
                # æ­¥éª¤80: æ ‡å‡†åŒ–tvname
                tvname = normalize_tvname(tvname)
                
                # æ­¥éª¤90: display_nameåˆå§‹åŒ–ä¸ºtvname
                display_name = tvname
                
                # æ­¥éª¤100: æ ¹æ®tvnameå¤„ç†
                final_group_cat = current_group_cat
                final_tvname = tvname
                final_display_name = display_name
                
                # æ­¥éª¤100.1-100.3: å¤„ç†ç‰¹æ®Šé¢‘é“
                final_tvname, final_display_name = process_special_channels(final_tvname)
                
                # æ­¥éª¤100.5: å¤„ç†CETV/CGTN
                if "CETV" in final_tvname or "CGTN" in final_tvname:
                    final_group_cat = "å¤®è§†"
                    final_tvname, final_display_name = process_cgtn_channels(final_tvname)
                
                # æ­¥éª¤100.7: å¤„ç†CCTVé¢‘é“
                elif "CCTV" in final_tvname:
                    final_group_cat = "å¤®è§†"
                    final_tvname, final_display_name = process_cctv_channels(final_tvname)
                
                # æ„å»ºlogo URL
                logo_url = build_logo_url(final_tvname)
                
                return current_group_orig, current_group_cat, {
                    'tvname': final_tvname,
                    'display_name': final_display_name,
                    'tvlink': tvlink,
                    'group_orig': current_group_orig,
                    'group_cat': final_group_cat,
                    'group_flat': GROUP_FLAT,
                    'logo_url': logo_url
                }

        def main():
            """ä¸»å¤„ç†å‡½æ•°"""
            # æ­¥éª¤10: æ‰“å¼€è¾“å‡ºæ–‡ä»¶
            with (
                open('MY9åŸç‰ˆ.m3u', 'w', encoding='utf-8') as f_orig,
                open('MY9åˆ†èŠ‚ç›®.m3u', 'w', encoding='utf-8') as f_cat,
                open('MY9æ— åˆ†ç»„.m3u', 'w', encoding='utf-8') as f_flat
            ):
                # å†™å…¥æ–‡ä»¶å¤´
                m3u_header = f'#EXTM3U x-tvg-url="{EPG_URL}"\n'
                f_orig.write(m3u_header)
                f_cat.write(m3u_header)
                f_flat.write(m3u_header)
                
                # æ­¥éª¤30: åˆå§‹åŒ–å˜é‡
                group_orig = ""
                group_cat = "å«è§†"
                
                # æ­¥éª¤20: è·å–èŠ‚ç›®æºå†…å®¹
                response = requests.get(SOURCE_URL)
                all_lines = response.text.splitlines()
                
                # ä»ç¬¬ä¸‰è¡Œå¼€å§‹å¤„ç†
                for line in all_lines[2:]:
                    result = process_line(line, group_orig, group_cat)
                    group_orig, group_cat, channel_data = result
                    
                    if channel_data is None:
                        continue
                    
                    # æ­¥éª¤110: å†™å…¥åŸç‰ˆæ–‡ä»¶
                    write_channel_entry(
                        f_orig,
                        channel_data['tvname'],
                        channel_data['group_orig'],
                        channel_data['display_name'],
                        channel_data['tvlink'],
                        channel_data['logo_url']
                    )
                    
                    # æ­¥éª¤120: å†™å…¥åˆ†ç±»ç‰ˆ
                    write_channel_entry(
                        f_cat,
                        channel_data['tvname'],
                        channel_data['group_cat'],
                        channel_data['display_name'],
                        channel_data['tvlink'],
                        channel_data['logo_url']
                    )
                    
                    # æ­¥éª¤130: å†™å…¥æ— åˆ†ç»„ç‰ˆ
                    write_channel_entry(
                        f_flat,
                        channel_data['tvname'],
                        channel_data['group_flat'],
                        channel_data['display_name'],
                        channel_data['tvlink'],
                        channel_data['logo_url']
                    )

        if __name__ == "__main__":
            main()
        EOF
        
        python tv_processor.py
      
    - name: å¼€å§‹æ¨é€
      run: |
        # é…ç½®Git
        git config --global user.name "Auto Sync"
        git config --global user.email "auto@sync.com"
        USER="tyrian9905"
        REPO="iptv"
        
        # è·å–åŒ—äº¬æ—¶é—´
        export TZ='Asia/Shanghai'
        BEIJING_TIME=$(date '+%Y-%m-%d %H:%M:%S')
        
        # å…‹éš†ä»“åº“
        git clone https://oauth2:${{ secrets.GITEE_TOKEN }}@gitee.com/${USER}/${REPO}.git
        
        # è¿›å…¥ä»“åº“å¹¶æ›´æ–°æ–‡ä»¶
        cd ${REPO}
        
        # ç¡®ä¿ç›®å½•å­˜åœ¨
        mkdir -p iptv
        
        # å¤åˆ¶æ‰€æœ‰å¹¿å‘Šè§„åˆ™æ–‡ä»¶
        cp ../*.m3u ./iptv/ 2>/dev/null || true
        
        # æ·»åŠ dnsblockç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶
        git add iptv/
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
        if ! git diff --cached --quiet; then
          git commit -m "è‡ªåŠ¨åŒæ­¥æ–‡ä»¶ ${BEIJING_TIME}"
          git push origin master
          echo "âœ… æ–‡ä»¶å·²åŒæ­¥ï¼"
        else
          echo "âš ï¸ æ²¡æœ‰æ–‡ä»¶å˜æ›´ï¼Œè·³è¿‡æäº¤"
        fi
        
        echo "ğŸ‰ èŠ‚ç›®m3uæ›´æ–°æˆåŠŸï¼"
