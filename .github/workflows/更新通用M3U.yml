name: æ›´æ–°é€šç”¨M3U

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  schedule:
  # åŒ—äº¬æ—¶é—´å‡Œæ™¨2ç‚¹ = UTCæ—¶é—´å‰ä¸€å¤©18ç‚¹
  - cron: '20 1,9 * * *'

jobs:
  process:
    runs-on: ubuntu-latest
    timeout-minutes: 3
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests
        
    - name: Process TV Channels
      run: |
        cat <<'EOF'>tv_processor.py
        import re
        import requests
        from urllib.parse import quote

        # ==================== é…ç½®å‚æ•° ====================
        SOURCE_URL = "https://raw.githubusercontent.com/jn950/live/refs/heads/main/tv/pllive.txt"
        LOGO_URL = "https://raw.githubusercontent.com/fanmingming/live/main/tv/"
        EPG_URL = "https://gitee.com/tyrian9905/iptv/raw/master/1day112114_epg.xml"
        GROUP_FLAT = "MY9"

        # ==================== CCTVæ˜¾ç¤ºåç§°æ˜ å°„ ====================
        CCTV_DISPLAY_NAMES = {
            "CCTV1": "CCTV-1 ç»¼åˆ",
            "CCTV2": "CCTV-2 è´¢ç»",
            "CCTV3": "CCTV-3 ç»¼è‰º",
            "CCTV4": "CCTV-4 ä¸­æ–‡å›½é™…",
            "CCTV5": "CCTV-5 ä½“è‚²",
            "CCTV6": "CCTV-6 ç”µå½±",
            "CCTV7": "CCTV-7 å›½é˜²å†›äº‹",
            "CCTV8": "CCTV-8 ç”µè§†å‰§",
            "CCTV9": "CCTV-9 çºªå½•",
            "CCTV11": "CCTV-11 æˆæ›²",
            "CCTV12": "CCTV-12 ç¤¾ä¼šä¸æ³•",
            "CCTV13": "CCTV-13 æ–°é—»",
            "CCTV14": "CCTV-14 å°‘å„¿",
            "CCTV15": "CCTV-15 éŸ³ä¹",
            "CCTV16": "CCTV-16 å¥¥æ—åŒ¹å…‹",
            "CCTV17": "CCTV-17 å†œä¸šå†œæ‘"
        }

        def normalize_channel_name(dsname):
            """æ­¥éª¤80: æ ‡å‡†åŒ–é¢‘é“åç§°"""
            tvname = dsname.upper()
            characters_to_remove = [' ', '-', 'FHD', 'HD', 'SD', 'é«˜æ¸…', 'æ ‡æ¸…', 'è¶…æ¸…']
            for char in characters_to_remove:
                tvname = tvname.replace(char, '')
            return tvname

        def process_cctv_channel(tvname):
            """æ­¥éª¤110-ä¸‰: å¤„ç†CCTVé¢‘é“"""
            # 110-ä¸‰-1: 3Dé¢‘é“
            if "3D" in tvname:
                return "CCTV3D", "CCTV 3D"
            
            # 110-ä¸‰-2: ç¾æ´²é¢‘é“
            if "ç¾æ´²" in tvname or "AME" in tvname:
                return "CCTV4ç¾æ´²", "CCTV-4 ç¾æ´²"
            
            # 110-ä¸‰-3: æ¬§æ´²é¢‘é“
            if "æ¬§æ´²" in tvname or "EUO" in tvname:
                return "CCTV4æ¬§æ´²", "CCTV-4 æ¬§æ´²"
            
            # 110-ä¸‰-4: 5+é¢‘é“
            if "+" in tvname or "PLUS" in tvname:
                return "CCTV5+", "CCTV-5+ ä½“è‚²èµ›äº‹"
            
            # 110-ä¸‰-5: CCTV10
            if "10" in tvname:
                return "CCTV10", "CCTV-10 ç§‘æ•™"
            
            # 110-ä¸‰-6: å…¶ä»–CCTVæ•°å­—é¢‘é“
            modified_name = tvname.replace("0", "") + "HD"
            pattern = r"(CCTV\d{1,2})[^\d]"
            match = re.search(pattern, modified_name)
            
            if match:
                cctv_num = match.group(1)
                display_name = CCTV_DISPLAY_NAMES.get(cctv_num, tvname)
                return cctv_num, display_name
            
            return tvname, tvname

        def write_channel_entry(file_obj, tvname, group_name, display_name, url):
            """å†™å…¥M3Ué¢‘é“æ¡ç›®"""
            safe_tvname = quote(tvname.replace("/", ""))
            entry = f'#EXTINF:-1 tvg-name="{tvname}" '
            entry += f'tvg-logo="{LOGO_URL}{safe_tvname}.png" '
            entry += f'group-title="{group_name}",{display_name}\n'
            entry += f"{url}\n"
            file_obj.write(entry)

        def main():
            """ä¸»å¤„ç†å‡½æ•°"""
            # æ­¥éª¤10: æ‰“å¼€è¾“å‡ºæ–‡ä»¶
            with (
                open('MY9åŸç‰ˆ.m3u', 'w', encoding='utf-8') as f_orig,
                open('MY9åˆ†èŠ‚ç›®.m3u', 'w', encoding='utf-8') as f_cat,
                open('MY9æ— åˆ†ç»„.m3u', 'w', encoding='utf-8') as f_flat
            ):
                # å†™å…¥æ–‡ä»¶å¤´
                m3u_header = f'#EXTM3U x-tvg-url="{EPG_URL}"\n'
                f_orig.write(m3u_header)
                f_cat.write(m3u_header)
                f_flat.write(m3u_header)
                
                # æ­¥éª¤30: åˆå§‹åŒ–å˜é‡
                group_orig = ""
                group_cat = "å«è§†"
                
                # æ­¥éª¤20: è·å–èŠ‚ç›®æºå†…å®¹
                response = requests.get(SOURCE_URL)
                all_lines = response.text.splitlines()
                
                # ä»ç¬¬ä¸‰è¡Œå¼€å§‹å¤„ç†
                for line in all_lines[2:]:
                    # æ­¥éª¤40: è·³è¿‡ç©ºç™½è¡Œ
                    line = line.strip()
                    if not line:
                        continue
                    
                    # æ­¥éª¤50: åˆ†å‰²è¡Œå†…å®¹
                    parts = line.split(',', 1)
                    if len(parts) < 2:
                        continue
                    
                    str1, str2 = parts[0].strip(), parts[1].strip()
                    
                    # æ­¥éª¤60: å¤„ç†str2çš„ä¸åŒæƒ…å†µ
                    if not str2:
                        # æƒ…å†µ1: str2ä¸ºç©ºï¼Œè·³è¿‡
                        continue
                    elif str2 == "#genre#":
                        # æƒ…å†µ2: åˆ†ç»„è¡Œ
                        group_orig = str1
                        continue
                    else:
                        # æƒ…å†µ3: é¢‘é“è¡Œ
                        dsname = str1
                        tvlink = str2
                    
                    # æ­¥éª¤70: è·³è¿‡4K/8Ké¢‘é“
                    if "4K" in dsname or "8K" in dsname:
                        continue
                    
                    # æ­¥éª¤80: æ ‡å‡†åŒ–é¢‘é“åç§°
                    tvname = normalize_channel_name(dsname)
                    
                    # æ­¥éª¤90: å†™å…¥åŸç‰ˆæ–‡ä»¶
                    write_channel_entry(f_orig, tvname, group_orig, dsname, tvlink)
                    
                    # æ­¥éª¤100: é‡ç½®dsnameä¸ºtvname
                    dsname = tvname
                    
                    # æ­¥éª¤110: å¤„ç†åˆ†ç±»é€»è¾‘
                    current_group_cat = group_cat
                    current_tvname = tvname
                    current_dsname = dsname
                    
                    # æ­¥éª¤110-ä¸€: è·³è¿‡ç‰¹å®šå«è§†é¢‘é“
                    if re.search(r"å«è§†[\d]", tvname):
                        continue
                    
                    # æ­¥éª¤110-äºŒ: å¤„ç†CETV/CGTN
                    if "CETV" in tvname or "CGTN" in tvname:
                        current_group_cat = "å¤®è§†"
                    
                    # æ­¥éª¤110-ä¸‰: å¤„ç†CCTVé¢‘é“
                    elif "CCTV" in tvname:
                        current_group_cat = "å¤®è§†"
                        current_tvname, current_dsname = process_cctv_channel(tvname)
                    
                    # æ­¥éª¤120: å†™å…¥åˆ†ç±»ç‰ˆ
                    write_channel_entry(f_cat, current_tvname, current_group_cat, current_dsname, tvlink)
                    
                    # æ­¥éª¤130: å†™å…¥æ— åˆ†ç»„ç‰ˆ
                    write_channel_entry(f_flat, current_tvname, GROUP_FLAT, current_dsname, tvlink)

        if __name__ == "__main__":
            main()
        EOF
        
        python tv_processor.py
      
    - name: æ¨é€åˆ°Gitee
      run: |
        # é…ç½®Git
        git config --global user.name "Auto Sync"
        git config --global user.email "auto@sync.com"
        USER="tyrian9905"    # â† ç”¨æˆ·å
        REPO="iptv"        # â† ä»“åº“å
        
        export TZ='Asia/Shanghai'
        # è·å–åŒ—äº¬æ—¶é—´
        BEIJING_TIME=$(date '+%Y-%m-%d %H:%M:%S')
        
        # å…‹éš†ä»“åº“
        git clone https://oauth2:${{ secrets.GITEE_TOKEN }}@gitee.com/${USER}/${REPO}.git
        
        # è¿›å…¥ä»“åº“å¹¶æ›´æ–°æ–‡ä»¶
        cd ${REPO}
        
        # å¤åˆ¶æ–‡ä»¶
        cp ../MY9åŸç‰ˆ.m3u ./
        cp ../MY9åˆ†èŠ‚ç›®.m3u ./
        cp ../MY9æ— åˆ†ç»„.m3u ./
        
        # æäº¤å¹¶æ¨é€
        git add MY9åŸç‰ˆ.m3u MY9åˆ†èŠ‚ç›®.m3u MY9æ— åˆ†ç»„.m3u
        git commit -m "è‡ªåŠ¨åŒæ­¥ ${BEIJING_TIME}"
        git push origin master
        
        echo "ğŸ‰ èŠ‚ç›®m3uæ›´æ–°æˆåŠŸï¼"
