name: æ›´æ–°é€šç”¨M3U

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  schedule:
  # åŒ—äº¬æ—¶é—´å‡Œæ™¨2ç‚¹ = UTCæ—¶é—´å‰ä¸€å¤©18ç‚¹
  - cron: '20 1,9 * * *'

jobs:
  process:
    runs-on: ubuntu-latest
    timeout-minutes: 3
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests
        
    - name: Process TV Channels
      run: |
        cat <<'EOF'>tv_processor.py
        import re
        import requests
        from urllib.parse import quote

        # å¸¸é‡å®šä¹‰
        SOURCE_URL = "https://raw.githubusercontent.com/jn950/live/refs/heads/main/tv/pllive.txt"
        LOGO_URL = "https://raw.githubusercontent.com/fanmingming/live/main/tv/"
        EPG_URL = "https://gitee.com/tyrian9905/iptv/raw/master/1day112114_epg.xml"
        GROUP_FLAT = "MY9"

        def process_line_content(line, group_orig, group_cat):
            """å¤„ç†å•è¡Œå†…å®¹"""
            line = line.strip()
            # 20. è·³è¿‡ç©ºç™½è¡Œ
            if not line:
                return group_orig, group_cat, None
                
            # 30. åˆ†å‰²è¡Œå†…å®¹
            str1, str2 = line.split(',', 1)
            str1, str2 = str1.strip(), str2.strip()
            
            # 40. æ ¹æ®str2çš„å€¼å¤„ç†
            if not str2:  # æƒ…å†µ1: str2æ˜¯ç©ºå­—ç¬¦ä¸²
                return group_orig, group_cat, None
            elif str2 == "#genre#":  # æƒ…å†µ2: æ˜¯åˆ†ç»„æ ‡è¯†
                group_orig = str1
                return group_orig, group_cat, None
            else:  # æƒ…å†µ3: æ˜¯é¢‘é“è¡Œ
                dsname = str1
                tvlink = str2
                
                # 50. è·³è¿‡4K/8Ké¢‘é“
                if "4K" in dsname or "8K" in dsname:
                    return group_orig, group_cat, None
                
                # 60. æ ‡å‡†åŒ–é¢‘é“åç§°
                tvname = dsname.upper()
                for remove_str in [' ', '-', 'FHD', 'HD', 'SD', 'é«˜æ¸…', 'æ ‡æ¸…', 'è¶…æ¸…']:
                    tvname = tvname.replace(remove_str, '')
                
                return group_orig, group_cat, {
                    'dsname': dsname,
                    'tvname': tvname,
                    'tvlink': tvlink
                }

        def process_cctv_channel(tvname, dsname):
            """å¤„ç†CCTVé¢‘é“ï¼ˆ80.ä¸‰ï¼‰"""
            # 1. 3Dé¢‘é“
            if "3D" in tvname:
                return "CCTV3D", "CCTV 3D"
            
            # 2. ç¾æ´²é¢‘é“
            if "ç¾æ´²" in tvname or "AME" in tvname:
                return "CCTV4ç¾æ´²", "CCTV-4 ç¾æ´²"
            
            # 3. æ¬§æ´²é¢‘é“
            if "æ¬§æ´²" in tvname or "EUO" in tvname:
                return "CCTV4æ¬§æ´²", "CCTV-4 æ¬§æ´²"
            
            # 4. 5+é¢‘é“
            if "+" in tvname or "PLUS" in tvname:
                return "CCTV5+", "CCTV-5+ ä½“è‚²èµ›äº‹"
            
            # 5. CCTV10
            if "10" in tvname:
                return "CCTV10", "CCTV-10 ç§‘æ•™"
            
            # 6. å…¶ä»–CCTVæ•°å­—é¢‘é“
            modified_name = tvname.replace("0", "") + "HD"
            pattern = r"(CCTV\d{1,2})[^\d]"
            match = re.search(pattern, modified_name)
            
            if match:
                cctv_num = match.group(1)
                cctv_display_names = {
                    "CCTV1": "CCTV-1 ç»¼åˆ",
                    "CCTV2": "CCTV-2 è´¢ç»",
                    "CCTV3": "CCTV-3 ç»¼è‰º",
                    "CCTV4": "CCTV-4 ä¸­æ–‡å›½é™…",
                    "CCTV5": "CCTV-5 ä½“è‚²",
                    "CCTV6": "CCTV-6 ç”µå½±",
                    "CCTV7": "CCTV-7 å›½é˜²å†›äº‹",
                    "CCTV8": "CCTV-8 ç”µè§†å‰§",
                    "CCTV9": "CCTV-9 çºªå½•",
                    "CCTV11": "CCTV-11 æˆæ›²",
                    "CCTV12": "CCTV-12 ç¤¾ä¼šä¸æ³•",
                    "CCTV13": "CCTV-13 æ–°é—»",
                    "CCTV14": "CCTV-14 å°‘å„¿",
                    "CCTV15": "CCTV-15 éŸ³ä¹",
                    "CCTV16": "CCTV-16 å¥¥æ—åŒ¹å…‹",
                    "CCTV17": "CCTV-17 å†œä¸šå†œæ‘"
                }
                display_name = cctv_display_names.get(cctv_num, dsname)
                return cctv_num, display_name
            
            return tvname, dsname

        def write_channel_entry(file, tvname, group, display_name, url):
            """å†™å…¥é¢‘é“æ¡ç›®"""
            safe_tvname = quote(tvname.replace("/", ""))
            entry = f'#EXTINF:-1 tvg-name="{tvname}" '
            entry += f'tvg-logo="{LOGO_URL}{safe_tvname}.png" '
            entry += f'group-title="{group}",{display_name}\n'
            entry += f"{url}\n"
            file.write(entry)

        def process_channels():
            """ä¸»å¤„ç†å‡½æ•°"""
            # 10. è·å–èŠ‚ç›®æºå†…å®¹ï¼ˆä»ç¬¬ä¸‰è¡Œå¼€å§‹ï¼‰
            response = requests.get(SOURCE_URL)
            lines = response.text.splitlines()
            content_lines = lines[2:]  # è·³è¿‡å‰ä¸¤è¡Œ
            
            # 5. æ‰“å¼€è¾“å‡ºæ–‡ä»¶
            with (
                open('MY9åŸç‰ˆ.m3u', 'w', encoding='utf-8') as f_orig,
                open('MY9åˆ†èŠ‚ç›®.m3u', 'w', encoding='utf-8') as f_cat,
                open('MY9æ— åˆ†ç»„.m3u', 'w', encoding='utf-8') as f_flat
            ):
                # å†™å…¥æ–‡ä»¶å¤´
                header = f'#EXTM3U x-tvg-url="{EPG_URL}"\n'
                f_orig.write(header)
                f_cat.write(header)
                f_flat.write(header)
                
                # 15. åˆå§‹åŒ–å˜é‡
                group_orig = ""
                group_cat = "å«è§†"
                
                # å¤„ç†æ¯ä¸€è¡Œ
                for line in content_lines:
                    result = process_line_content(line, group_orig, group_cat)
                    group_orig, group_cat, channel_info = result
                    
                    if channel_info is None:
                        continue
                    
                    dsname = channel_info['dsname']
                    tvname = channel_info['tvname']
                    tvlink = channel_info['tvlink']
                    
                    # 70. å†™å…¥åŸç‰ˆæ–‡ä»¶
                    write_channel_entry(f_orig, tvname, group_orig, dsname, tvlink)
                    
                    # 80. å¤„ç†åˆ†ç±»é€»è¾‘
                    current_group_cat = group_cat
                    current_tvname = tvname
                    current_dsname = dsname
                    
                    # 80.ä¸€ è·³è¿‡ç‰¹å®šå«è§†é¢‘é“
                    if re.search(r"å«è§†[\d]", tvname):
                        continue
                    
                    # 80.äºŒ å¤„ç†CETV/CGTN
                    if "CETV" in tvname or "CGTN" in tvname:
                        current_group_cat = "å¤®è§†"
                    
                    # 80.ä¸‰ å¤„ç†CCTVé¢‘é“
                    elif "CCTV" in tvname:
                        current_group_cat = "å¤®è§†"
                        current_tvname, current_dsname = process_cctv_channel(tvname, dsname)
                    
                    # 90. å†™å…¥åˆ†ç±»ç‰ˆ
                    write_channel_entry(f_cat, current_tvname, current_group_cat, current_dsname, tvlink)
                    
                    # 90. å†™å…¥æ— åˆ†ç»„ç‰ˆ
                    write_channel_entry(f_flat, current_tvname, GROUP_FLAT, current_dsname, tvlink)

        if __name__ == "__main__":
            process_channels()
        EOF
        
        python tv_processor.py
      
    - name: æ¨é€åˆ°Gitee
      run: |
        # é…ç½®Git
        git config --global user.name "Auto Sync"
        git config --global user.email "auto@sync.com"
        USER="tyrian9905"    # â† ç”¨æˆ·å
        REPO="iptv"        # â† ä»“åº“å
        
        export TZ='Asia/Shanghai'
        # è·å–åŒ—äº¬æ—¶é—´
        BEIJING_TIME=$(date '+%Y-%m-%d %H:%M:%S')
        
        # å…‹éš†ä»“åº“
        git clone https://oauth2:${{ secrets.GITEE_TOKEN }}@gitee.com/${USER}/${REPO}.git
        
        # è¿›å…¥ä»“åº“å¹¶æ›´æ–°æ–‡ä»¶
        cd ${REPO}
        
        # å¤åˆ¶æ–‡ä»¶
        cp ../MY9åŸç‰ˆ.m3u ./
        cp ../MY9åˆ†èŠ‚ç›®.m3u ./
        cp ../MY9æ— åˆ†ç»„.m3u ./
        
        # æäº¤å¹¶æ¨é€
        git add MY9åŸç‰ˆ.m3u MY9åˆ†èŠ‚ç›®.m3u MY9æ— åˆ†ç»„.m3u
        git commit -m "è‡ªåŠ¨åŒæ­¥ ${BEIJING_TIME}"
        git push origin master
        
        echo "ğŸ‰ èŠ‚ç›®m3uæ›´æ–°æˆåŠŸï¼"
