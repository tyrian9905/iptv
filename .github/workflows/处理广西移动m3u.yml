name: å¤„ç†å¹¿è¥¿ç§»åŠ¨M3Uè‡³Gitee

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  schedule:
  # åŒ—äº¬æ—¶é—´å‡Œæ™¨2ç‚¹ = UTCæ—¶é—´å‰ä¸€å¤©18ç‚¹
  - cron: '0 18 * * *'  # UTCæ—¶é—´18ç‚¹æ‰§è¡Œï¼ˆåŒ—äº¬æ—¶é—´ç¬¬äºŒå¤©2ç‚¹ï¼‰

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
    - name: ä¸‹è½½åŸå§‹IPTVæ–‡ä»¶
      run: |
        curl -s -o gxmobile.m3u https://raw.githubusercontent.com/Healer-sys/Home/main/iptv/gx.m3u
        curl -s -o æ¸¯æ¾³åŠ4K.txt https://raw.githubusercontent.com/tyrian9905/iptv/main/æ¸¯æ¾³åŠ4K.txt
        
    - name: å¤„ç†IPTVæ–‡ä»¶ï¼ˆè¿‡æ»¤è¶…æ¸…ææ¸…å’Œ4Kèµ„æºï¼‰
      run: |
        # åˆ›å»ºè¿‡æ»¤è„šæœ¬
        cat > filter_channels.sh << 'EOF'
        #!/bin/bash
        
        input_file="gxmobile.m3u"
        output_file="gxmobile_SD.m3u"
        
        # æ¸…ç©ºè¾“å‡ºæ–‡ä»¶
        > "$output_file"
        
        # é€è¡Œå¤„ç†M3Uæ–‡ä»¶
        while IFS= read -r line
        do
            # å¦‚æœæ˜¯EXTM3Uå¤´æˆ–ç©ºç™½è¡Œï¼Œç›´æ¥è¾“å‡º
            if [[ "$line" == "#EXTM3U" ]] || [[ -z "$line" ]]; then
                echo "$line" >> "$output_file"
                continue
            fi
            
            # å¦‚æœæ˜¯é¢‘é“ä¿¡æ¯è¡Œï¼ˆåŒ…å«tvg-nameï¼‰
            if [[ "$line" == "#EXTINF"* ]]; then
                # æ£€æŸ¥æ˜¯å¦åŒ…å«"è¶…æ¸…"æˆ–"çº¯äº«4K"æˆ–"ææ¸…"
                if [[ "$line" == *"è¶…æ¸…"* ]] || [[ "$line" == *"ææ¸…"* ]] || [[ "$line" == *"çº¯äº«4K"* ]]; then
                    # è·³è¿‡è¿™ä¸ªé¢‘é“ï¼ˆåŒ…æ‹¬ä¸‹ä¸€è¡Œçš„URLï¼‰
                    skip_next=true
                else
                    # ä¿ç•™è¿™ä¸ªé¢‘é“
                    echo "$line" >> "$output_file"
                    skip_next=false
                fi
            elif [[ "$skip_next" == true ]]; then
                # è·³è¿‡è¿™ä¸ªé¢‘é“çš„URLè¡Œ
                skip_next=false
            else
                # è¾“å‡ºURLè¡Œ
                echo "$line" >> "$output_file"
            fi
        done < "$input_file"
        
        echo "âœ… æ–‡ä»¶å¤„ç†å®Œæˆï¼š"
        echo "åŸå§‹æ–‡ä»¶è¡Œæ•°: $(wc -l < "$input_file")"
        echo "å¤„ç†åè¡Œæ•°: $(wc -l < "$output_file")"
        
        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä¸ºç©º
        if [[ ! -s "$output_file" ]]; then
            echo "âŒ è­¦å‘Šï¼šå¤„ç†åçš„æ–‡ä»¶ä¸ºç©ºï¼"
            exit 1
        fi
        EOF
        
        # æ‰§è¡Œè¿‡æ»¤è„šæœ¬
        chmod +x filter_channels.sh
        ./filter_channels.sh
        
        # éªŒè¯å¤„ç†ç»“æœ
        echo "ğŸ” å¤„ç†ç»“æœéªŒè¯ï¼š"
        grep -E "è¶…æ¸…|ææ¸…" gxmobile_SD.m3u || echo "âœ… å·²æˆåŠŸè¿‡æ»¤è¶…æ¸…å’Œææ¸…4Kèµ„æº"
        grep -E "é«˜æ¸…|æ ‡æ¸…" gxmobile_SD.m3u | head -5 | sed 's/^/  ä¿ç•™é¢‘é“: /' || echo "âš ï¸ æœªæ‰¾åˆ°é«˜æ¸…æˆ–æ ‡æ¸…é¢‘é“"
    - name: ä¿®æ”¹EPGæºURLå¹¶æ¸…ç†tvg-nameå­—ç¬¦
      run: |
        echo "ğŸ”„ ä¿®æ”¹EPGæºURLå¹¶æ¸…ç†tvg-nameå­—ç¬¦..."
        
        # å®šä¹‰æ–°çš„EPGæºURL
        new_epg_url='http://e.erw.cc/e.xml'
        
        # å¤„ç†ä¸¤ä¸ªæ–‡ä»¶
        for file in gxmobile.m3u gxmobile_SD.m3u
        do
            if [[ -f "$file" ]]; then
                echo "æ­£åœ¨å¤„ç†æ–‡ä»¶: $file"
                
                # åˆ›å»ºä¸´æ—¶æ–‡ä»¶
                temp_file="${file}.temp"
                
                # é€è¡Œå¤„ç†æ–‡ä»¶
                while IFS= read -r line
                do
                    # 1. å¤„ç†EPGæºURLï¼ˆç¬¬ä¸€è¡Œï¼‰
                    if [[ "$line" =~ ^#EXTM3U ]]; then
                        # æ›¿æ¢x-tvg-urlå€¼
                        line=$(echo "$line" | sed "s|x-tvg-url=\"[^\"]*\"|x-tvg-url=\"$new_epg_url\"|g")
                    fi
                    
                    # 2. å¤„ç†tvg-nameå­—æ®µä¸­çš„æŒ‡å®šå­—ç¬¦
                    if [[ "$line" =~ tvg-name=\"([^\"]*)\" ]]; then
                        # æå–tvg-nameçš„å€¼
                        tvg_name="${BASH_REMATCH[1]}"
                        original_tvg_name="$tvg_name"
                        
                        # ä¸¥æ ¼æŒ‰ç…§è¦æ±‚åˆ é™¤æŒ‡å®šå­—ç¬¦ï¼ˆæ³¨æ„ç©ºæ ¼ï¼‰
                        tvg_name="${tvg_name// è¶…æ¸…/}"
                        tvg_name="${tvg_name// é«˜æ¸…/}"
                        tvg_name="${tvg_name// æ ‡æ¸…/}"
                        tvg_name="${tvg_name// ææ¸…/}"
                        tvg_name="${tvg_name// 4K/}"
                        tvg_name="${tvg_name//æ ‡æ¸…4M/}"
                        tvg_name="${tvg_name//(æ ‡æ¸…)/}"
                        tvg_name="${tvg_name//-/}"
                        
                        # æ–°å¢ï¼šå°†"ç æ±Ÿå«è§†"æ”¹ä¸º"å¹¿ä¸œç æ±Ÿ"
                        tvg_name="${tvg_name//ç æ±Ÿå«è§†/å¹¿ä¸œç æ±Ÿ}"
                        
                        # å¦‚æœtvg-nameè¢«ä¿®æ”¹è¿‡ï¼Œæ›¿æ¢æ•´è¡Œ
                        if [[ "$tvg_name" != "$original_tvg_name" ]]; then
                            line="${line//tvg-name=\"$original_tvg_name\"/tvg-name=\"$tvg_name\"}"
                        fi
                    fi
                    
                    # 3. æ£€æŸ¥tvg-nameæ˜¯å¦åŒ…å«"å«è§†"å¹¶æ›´æ–°group-titleä¸º"å…¨å›½å«è§†"
                    if [[ "$line" =~ tvg-name=\"([^\"]*)\" ]]; then
                        # æå–tvg-nameçš„å€¼
                        tvg_name="${BASH_REMATCH[1]}"
                        
                        # æ£€æŸ¥tvg-nameæ˜¯å¦åŒ…å«"å«è§†"
                        if [[ "$tvg_name" == *"å«è§†"* ]] || [[ "$tvg_name" == *"å¹¿ä¸œç æ±Ÿ"* ]] ; then
                            # å¦‚æœå­˜åœ¨group-titleï¼Œæ›¿æ¢ä¸º"å…¨å›½å«è§†"
                            if [[ "$line" =~ group-title=\"([^\"]*)\" ]]; then
                                # æ›¿æ¢ç°æœ‰çš„group-title
                                line="${line//group-title=\"${BASH_REMATCH[1]}\"/group-title=\"å…¨å›½å«è§†\"}"
                            else
                                # å¦‚æœæ²¡æœ‰group-titleï¼Œæ·»åŠ ä¸€ä¸ª
                                line="${line}, group-title=\"å…¨å›½å«è§†\""
                            fi
                        fi
                    fi
                    
                    # 4. å°†"æœ¬åœ°åŠç‰¹è‰²"æ›´æ”¹ä¸º"å¹¿è¥¿çƒ­æ’­"
                    if [[ "$line" =~ group-title=\"æœ¬åœ°åŠç‰¹è‰²\" ]]; then
                        line="${line//group-title=\"æœ¬åœ°åŠç‰¹è‰²\"/group-title=\"å¹¿è¥¿çƒ­æ’­\"}"
                    fi

                    # 5. æ·»åŠ å›æ”¾åŠŸèƒ½
                    if [[ "$line" == *"?servicetype=1" ]]; then
                        line="${line//?servicetype=1/?servicetype=1?servicetype=3}"
                    fi

                    echo "$line" >> "$temp_file"
                done < "$file"
                
                # æ›¿æ¢åŸæ–‡ä»¶
                mv "$temp_file" "$file"
                echo "" >> "$file"  # ç¡®ä¿æœ‰ç©ºè¡Œ
                cat æ¸¯æ¾³åŠ4K.txt >> "$file"
                echo "âœ… å·²å¤„ç† $file" 
            else
                echo "âš ï¸ æ–‡ä»¶ $file ä¸å­˜åœ¨ï¼Œè·³è¿‡å¤„ç†"
            fi
        done
    - name: æ¨é€åˆ°Gitee
      run: |
        # è®¾ç½®å˜é‡
        USER="tyrian9905"    # â† ç”¨æˆ·å
        REPO="iptv"        # â† ä»“åº“å
        TOKEN="a74325e9ecd2a8f505b8cd8d9b7138a0"      # â† Token
        
        # é…ç½®Git
        git config --global user.name "Auto Sync"
        git config --global user.email "auto@sync.com"
        
        export TZ='Asia/Shanghai'
        # è·å–åŒ—äº¬æ—¶é—´
        BEIJING_TIME=$(date '+%Y-%m-%d %H:%M:%S')
        
        # å…‹éš†ä»“åº“
        git clone https://oauth2:${TOKEN}@gitee.com/${USER}/${REPO}.git
        
        # è¿›å…¥ä»“åº“å¹¶æ›´æ–°æ–‡ä»¶
        cd ${REPO}
        
        # å¤åˆ¶å¤„ç†å‰çš„æ–‡ä»¶
        cp ../gxmobile.m3u ./
        
        # å¤åˆ¶å¤„ç†åçš„æ–‡ä»¶
        cp ../gxmobile_SD.m3u ./
        
        # æäº¤å¹¶æ¨é€
        git add gxmobile.m3u gxmobile_SD.m3u
        git commit -m "è‡ªåŠ¨åŒæ­¥ ${BEIJING_TIME}
        - æ›´æ–°EPGæºï¼šhttps://baoer.org.cn/e.xml
        - æ¸…ç†tvg-nameå­—ç¬¦
        - 'ç æ±Ÿå«è§†' â†’ 'å¹¿ä¸œç æ±Ÿ'
        - 'å«è§†'é¢‘é“ â†’ group-title='å…¨å›½å«è§†'
        - 'æœ¬åœ°åŠç‰¹è‰²' â†’ 'å¹¿è¥¿çƒ­æ’­'
        - è¿‡æ»¤è¶…æ¸…/ææ¸…èµ„æºï¼ˆä»…SDç‰ˆæœ¬ï¼‰"
        git push origin master
        
        echo "ğŸ‰ åŒæ­¥æˆåŠŸï¼"
        echo "åŸå§‹æ–‡ä»¶: https://gitee.com/${USER}/${REPO}/raw/master/gxmobile.m3u"
        echo "è¿‡æ»¤åæ–‡ä»¶: https://gitee.com/${USER}/${REPO}/raw/master/gxmobile_SD.m3u"
        echo ""
        echo "ğŸ“Š æ–‡ä»¶ä¿¡æ¯ï¼š"
        echo "gxmobile.m3u å¤§å°: $(du -h gxmobile.m3u | cut -f1)"
        echo "gxmobile_SD.m3u å¤§å°: $(du -h gxmobile_SD.m3u | cut -f1)"
