
name: å¤„ç†å¹¿è¥¿ç§»åŠ¨M3Uè‡³Gitee

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  schedule:
  # åŒ—äº¬æ—¶é—´å‡Œæ™¨2ç‚¹ = UTCæ—¶é—´å‰ä¸€å¤©18ç‚¹
  - cron: '0 18 * * *'  # UTCæ—¶é—´18ç‚¹æ‰§è¡Œï¼ˆåŒ—äº¬æ—¶é—´ç¬¬äºŒå¤©2ç‚¹ï¼‰

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
    - name: ä¸‹è½½åŽŸå§‹IPTVæ–‡ä»¶
      run: |
        curl -s -o gxmobile.m3u https://raw.githubusercontent.com/Healer-sys/Home/main/iptv/gx.m3u

    - name: å¤„ç†IPTVæ–‡ä»¶ï¼ˆè¿‡æ»¤è¶…æ¸…æžæ¸…å’Œ4Kèµ„æºï¼‰
      run: |
        # åˆ›å»ºè¿‡æ»¤è„šæœ¬
        cat > filter_channels.sh << 'EOF'
        #!/bin/bash
        
        input_file="gxmobile.m3u"
        output_file="gxmobile_SD.m3u"
        
        # æ¸…ç©ºè¾“å‡ºæ–‡ä»¶
        > "$output_file"
        
        # é€è¡Œå¤„ç†M3Uæ–‡ä»¶
        while IFS= read -r line
        do
            # å¦‚æžœæ˜¯EXTM3Uå¤´æˆ–ç©ºç™½è¡Œï¼Œç›´æŽ¥è¾“å‡º
            if [[ "$line" == "#EXTM3U" ]] || [[ -z "$line" ]]; then
                echo "$line" >> "$output_file"
                continue
            fi
            
            # å¦‚æžœæ˜¯é¢‘é“ä¿¡æ¯è¡Œï¼ˆåŒ…å«tvg-nameï¼‰
            if [[ "$line" == "#EXTINF"* ]]; then
                # æ£€æŸ¥æ˜¯å¦åŒ…å«"è¶…æ¸…"æˆ–"çº¯äº«4K"æˆ–"æžæ¸…"
                if [[ "$line" == *"è¶…æ¸…"* ]] || [[ "$line" == *"æžæ¸…"* ]] || [[ "$line" == *"çº¯äº«4K"* ]]; then
                    # è·³è¿‡è¿™ä¸ªé¢‘é“ï¼ˆåŒ…æ‹¬ä¸‹ä¸€è¡Œçš„URLï¼‰
                    skip_next=true
                else
                    # ä¿ç•™è¿™ä¸ªé¢‘é“
                    echo "$line" >> "$output_file"
                    skip_next=false
                fi
            elif [[ "$skip_next" == true ]]; then
                # è·³è¿‡è¿™ä¸ªé¢‘é“çš„URLè¡Œ
                skip_next=false
            else
                # è¾“å‡ºURLè¡Œ
                echo "$line" >> "$output_file"
            fi
        done < "$input_file"
        
        echo "âœ… æ–‡ä»¶å¤„ç†å®Œæˆï¼š"
        echo "åŽŸå§‹æ–‡ä»¶è¡Œæ•°: $(wc -l < "$input_file")"
        echo "å¤„ç†åŽè¡Œæ•°: $(wc -l < "$output_file")"
        
        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä¸ºç©º
        if [[ ! -s "$output_file" ]]; then
            echo "âŒ è­¦å‘Šï¼šå¤„ç†åŽçš„æ–‡ä»¶ä¸ºç©ºï¼"
            exit 1
        fi
        EOF
        
        # æ‰§è¡Œè¿‡æ»¤è„šæœ¬
        chmod +x filter_channels.sh
        ./filter_channels.sh
        
        # éªŒè¯å¤„ç†ç»“æžœ
        echo "ðŸ” å¤„ç†ç»“æžœéªŒè¯ï¼š"
        grep -E "è¶…æ¸…|æžæ¸…|çº¯äº«4K" gxmobile_SD.m3u || echo "âœ… å·²æˆåŠŸè¿‡æ»¤è¶…æ¸…æžæ¸…å’Œ4Kèµ„æº"
        grep -E "é«˜æ¸…|æ ‡æ¸…" gxmobile_SD.m3u | head -5 | sed 's/^/  ä¿ç•™é¢‘é“: /' || echo "âš ï¸ æœªæ‰¾åˆ°é«˜æ¸…æˆ–æ ‡æ¸…é¢‘é“"

    - name: æ¸…ç†tvg-nameä¸­çš„æŒ‡å®šå­—ç¬¦
      run: |
        echo "ðŸ§¹ æ¸…ç† tvg-name ä¸­çš„æŒ‡å®šå­—ç¬¦..."
        
        # æ¸…ç†ä¸¤ä¸ªæ–‡ä»¶
        for file in gxmobile.m3u gxmobile_SD.m3u
        do
            if [[ -f "$file" ]]; then
                echo "æ­£åœ¨å¤„ç†æ–‡ä»¶: $file"
                # åˆ›å»ºä¸´æ—¶æ–‡ä»¶
                temp_file="${file}.temp"
                
                # å¤„ç†æ¯ä¸€è¡Œï¼Œåªæ¸…ç†tvg-nameå­—æ®µä¸­çš„æŒ‡å®šå­—ç¬¦
                while IFS= read -r line
                do
                    if [[ "$line" =~ tvg-name=\"([^\"]*)\" ]]; then
                        # æå–tvg-nameçš„å€¼
                        tvg_name="${BASH_REMATCH[1]}"
                        original_tvg_name="$tvg_name"
                        
                        # ä¸¥æ ¼æŒ‰ç…§è¦æ±‚åˆ é™¤æŒ‡å®šå­—ç¬¦ï¼ˆæ³¨æ„ç©ºæ ¼ï¼‰
                        tvg_name="${tvg_name// è¶…æ¸…/}"
                        tvg_name="${tvg_name// é«˜æ¸…/}"
                        tvg_name="${tvg_name//æ ‡æ¸…/}"
                        tvg_name="${tvg_name// æžæ¸…/}"
                        tvg_name="${tvg_name// 4K/}"
                        tvg_name="${tvg_name//æ ‡æ¸…4M/}"
                        tvg_name="${tvg_name//(æ ‡æ¸…)/}"
                        
                        # å¦‚æžœtvg-nameè¢«ä¿®æ”¹è¿‡ï¼Œæ›¿æ¢æ•´è¡Œ
                        if [[ "$tvg_name" != "$original_tvg_name" ]]; then
                            line="${line//tvg-name=\"$original_tvg_name\"/tvg-name=\"$tvg_name\"}"
                        fi
                    fi
                    echo "$line" >> "$temp_file"
                done < "$file"
                
                # æ›¿æ¢åŽŸæ–‡ä»¶
                mv "$temp_file" "$file"
                echo "âœ… å·²æ¸…ç† $file"
                
                # æ˜¾ç¤ºæ¸…ç†å‰åŽçš„å¯¹æ¯”
                echo "æ¸…ç†æ•ˆæžœç¤ºä¾‹ï¼š"
                grep -m 3 'tvg-name=' "$file" | while read -r line; do
                    echo "  æ¸…ç†åŽ: $line"
                done
            else
                echo "âš ï¸ æ–‡ä»¶ $file ä¸å­˜åœ¨ï¼Œè·³è¿‡æ¸…ç†"
            fi
        done

    - name: æŽ¨é€åˆ°Gitee
      run: |
        # è®¾ç½®å˜é‡
        USER="tyrian9905"    # â† ç”¨æˆ·å
        REPO="iptv"        # â† ä»“åº“å
        TOKEN="a74325e9ecd2a8f505b8cd8d9b7138a0"      # â† Token
        
        # é…ç½®Git
        git config --global user.name "Auto Sync"
        git config --global user.email "auto@sync.com"
        
        export TZ='Asia/Shanghai'
        # èŽ·å–åŒ—äº¬æ—¶é—´
        BEIJING_TIME=$(date '+%Y-%m-%d %H:%M:%S')
        
        # å…‹éš†ä»“åº“
        git clone https://oauth2:${TOKEN}@gitee.com/${USER}/${REPO}.git
        
        # è¿›å…¥ä»“åº“å¹¶æ›´æ–°æ–‡ä»¶
        cd ${REPO}
        
        # å¤åˆ¶å¤„ç†å‰çš„æ–‡ä»¶
        cp ../gxmobile.m3u ./
        
        # å¤åˆ¶å¤„ç†åŽçš„æ–‡ä»¶
        cp ../gxmobile_SD.m3u ./
        
        # æäº¤å¹¶æŽ¨é€
        git add gxmobile.m3u gxmobile_SD.m3u
        git commit -m "åŒæ­¥å¹¶è¿‡æ»¤é¢‘é“ ${BEIJING_TIME}
        - ä¿ç•™ï¼šé«˜æ¸…å’Œæ ‡æ¸…é¢‘é“
        - è¿‡æ»¤ï¼šè¶…æ¸…ã€æžæ¸…ã€çº¯äº«4Ké¢‘é“
        - æ¸…ç† tvg-name ä¸­çš„å­—ç¬¦ï¼š' è¶…æ¸…'ã€' é«˜æ¸…'ã€'æ ‡æ¸…'ã€' æžæ¸…'ã€' 4K'ã€'æ ‡æ¸…4M'ã€'(æ ‡æ¸…)'"
        git push origin master
        
        echo "ðŸŽ‰ åŒæ­¥æˆåŠŸï¼"
        echo "åŽŸå§‹æ–‡ä»¶: https://gitee.com/${USER}/${REPO}/raw/master/gxmobile.m3u"
        echo "è¿‡æ»¤åŽæ–‡ä»¶: https://gitee.com/${USER}/${REPO}/raw/master/gxmobile_SD.m3u"
        echo ""
        echo "ðŸ“Š æ–‡ä»¶ä¿¡æ¯ï¼š"
        echo "gxmobile.m3u å¤§å°: $(du -h gxmobile.m3u | cut -f1)"
        echo "gxmobile_SD.m3u å¤§å°: $(du -h gxmobile_SD.m3u | cut -f1)"
