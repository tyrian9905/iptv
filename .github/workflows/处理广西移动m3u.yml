name: å¤„ç†å¹¿è¥¿ç§»åŠ¨M3UåŒæ­¥è‡³Gitee

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  schedule:
  # åŒ—äº¬æ—¶é—´å‡Œæ™¨2ç‚¹ = UTCæ—¶é—´å‰ä¸€å¤©18ç‚¹
  - cron: '0 18 * * *'  # UTCæ—¶é—´18ç‚¹æ‰§è¡Œï¼ˆåŒ—äº¬æ—¶é—´ç¬¬äºŒå¤©2ç‚¹ï¼‰

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
    - name: ä¸‹è½½åŸå§‹IPTVæ–‡ä»¶
      run: |
        curl -s -o gxmobile.m3u https://raw.githubusercontent.com/Healer-sys/Home/main/iptv/gx.m3u
        echo "âœ… å·²ä¸‹è½½åŸå§‹æ–‡ä»¶ï¼Œå¤§å°: $(wc -l < gxmobile.m3u) è¡Œ"

    - name: è¿‡æ»¤è¶…æ¸…ææ¸…å’Œ4Kèµ„æº
      run: |
        echo "ğŸ” è¿‡æ»¤è¶…æ¸…ã€ææ¸…å’Œ4Kèµ„æº..."
        
        # ä½¿ç”¨grepåå‘è¿‡æ»¤æ›´é«˜æ•ˆ
        if grep -q "è¶…æ¸…\|ææ¸…\|çº¯äº«4K" gxmobile.m3u; then
          grep -v "è¶…æ¸…\|ææ¸…\|çº¯äº«4K" gxmobile.m3u > gxmobile_SD.m3u
        else
          cp gxmobile.m3u gxmobile_SD.m3u
        fi
        
        echo "âœ… è¿‡æ»¤å®Œæˆ"
        echo "åŸå§‹æ–‡ä»¶: $(wc -l < gxmobile.m3u) è¡Œ"
        echo "è¿‡æ»¤å: $(wc -l < gxmobile_SD.m3u) è¡Œ"
        
        # éªŒè¯ç»“æœ
        echo "ğŸ” éªŒè¯è¿‡æ»¤ç»“æœï¼š"
        if grep -q "è¶…æ¸…\|ææ¸…\|çº¯äº«4K" gxmobile_SD.m3u; then
          echo "âŒ è¿‡æ»¤å¤±è´¥ï¼Œä»åŒ…å«è¶…æ¸…/ææ¸…/4Kå†…å®¹"
          exit 1
        else
          echo "âœ… å·²æˆåŠŸè¿‡æ»¤è¶…æ¸…ã€ææ¸…å’Œ4Kèµ„æº"
        fi

    - name: ç»Ÿä¸€å¤„ç†M3Uæ–‡ä»¶
      run: |
        echo "ğŸ”„ ç»Ÿä¸€å¤„ç†M3Uæ–‡ä»¶ï¼ˆEPGæºå’Œåç§°æ¸…ç†ï¼‰..."
        
        # å¤„ç†ä¸¤ä¸ªæ–‡ä»¶
        for file in gxmobile.m3u gxmobile_SD.m3u
        do
          if [[ ! -f "$file" ]]; then
            echo "âš ï¸ æ–‡ä»¶ $file ä¸å­˜åœ¨ï¼Œè·³è¿‡"
            continue
          fi
          
          echo "æ­£åœ¨å¤„ç†: $file"
          
          # ä¸€æ¬¡æ€§ä½¿ç”¨sedè¿›è¡Œæ‰€æœ‰æ›¿æ¢æ“ä½œï¼Œæ›´é«˜æ•ˆ
          sed -i \
            -e 's|x-tvg-url="[^"]*"|x-tvg-url="https://baoer.org.cn/e.xml"|g' \
            -e 's/tvg-name="[^"]* è¶…æ¸…[^"]*"/tvg-name="&"/g' \
            -e 's/tvg-name="[^"]* é«˜æ¸…[^"]*"/tvg-name="&"/g' \
            -e 's/tvg-name="ç æ±Ÿå«è§†"/tvg-name="å¹¿ä¸œç æ±Ÿ"/g' \
            -e 's/ è¶…æ¸…//g' \
            -e 's/ é«˜æ¸…//g' \
            -e 's/ æ ‡æ¸…//g' \
            -e 's/ ææ¸…//g' \
            -e 's/ 4K//g' \
            -e 's/æ ‡æ¸…4M//g' \
            -e 's/(æ ‡æ¸…)//g' \
            -e 's/-//g' \
            "$file"
          
          # å¤„ç†group-titleé€»è¾‘
          temp_file="${file}.tmp"
          > "$temp_file"
          
          while IFS= read -r line
          do
            # å¤„ç†group-titleé€»è¾‘
            if [[ "$line" =~ tvg-name=\"([^\"]*)\" ]]; then
              tvg_name="${BASH_REMATCH[1]}"
              
              # å¦‚æœtvg-nameåŒ…å«"å«è§†"ï¼Œè®¾ç½®group-titleä¸º"å…¨å›½å«è§†"
              if [[ "$tvg_name" == *"å«è§†"* ]]; then
                if [[ "$line" =~ group-title=\"([^\"]*)\" ]]; then
                  line="${line//group-title=\"${BASH_REMATCH[1]}\"/group-title=\"å…¨å›½å«è§†\"}"
                else
                  line="${line}, group-title=\"å…¨å›½å«è§†\""
                fi
              fi
              
              # å°†"æœ¬åœ°åŠç‰¹è‰²"æ›´æ”¹ä¸º"å¹¿è¥¿çƒ­æ’­"
              if [[ "$line" =~ group-title=\"æœ¬åœ°åŠç‰¹è‰²\" ]]; then
                line="${line//group-title=\"æœ¬åœ°åŠç‰¹è‰²\"/group-title=\"å¹¿è¥¿çƒ­æ’­\"}"
              fi
            fi
            
            echo "$line" >> "$temp_file"
          done < "$file"
          
          mv "$temp_file" "$file"
          echo "âœ… $file å¤„ç†å®Œæˆ"
        done

    - name: æ¨é€åˆ°Gitee
      run: |
        # é…ç½®å˜é‡
        USER="tyrian9905"
        REPO="iptv"
        TOKEN="a74325e9ecd2a8f505b8cd8d9b7138a0"
        BEIJING_TIME=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')
        
        # é…ç½®Git
        git config --global user.name "Auto Sync"
        git config --global user.email "auto@sync.com"
        
        # å…‹éš†ä»“åº“
        echo "ğŸ“¡ å…‹éš†ä»“åº“..."
        git clone --depth 1 "https://oauth2:${TOKEN}@gitee.com/${USER}/${REPO}.git"
        
        # æ›´æ–°æ–‡ä»¶
        cd "${REPO}"
        cp ../gxmobile.m3u ./
        cp ../gxmobile_SD.m3u ./
        
        # æäº¤æ¨é€
        echo "ğŸ“ æäº¤æ›´æ”¹..."
        git add gxmobile.m3u gxmobile_SD.m3u
        git commit -m "$commit_msg"
        git push origin master
        
        echo ""
        echo "ğŸ‰ åŒæ­¥å®Œæˆï¼"
        echo "ğŸ“Š æ–‡ä»¶ä¿¡æ¯ï¼š"
        echo "  gxmobile.m3u: $(du -h gxmobile.m3u | cut -f1) | $(wc -l < gxmobile.m3u) è¡Œ"
        echo "  gxmobile_SD.m3u: $(du -h gxmobile_SD.m3u | cut -f1) | $(wc -l < gxmobile_SD.m3u) è¡Œ"
        echo ""
        echo "ğŸ”— è®¿é—®é“¾æ¥ï¼š"
        echo "  å®Œæ•´ç‰ˆï¼šhttps://gitee.com/${USER}/${REPO}/raw/master/gxmobile.m3u"
        echo "  æ ‡å‡†ç‰ˆï¼šhttps://gitee.com/${USER}/${REPO}/raw/master/gxmobile_SD.m3u"
