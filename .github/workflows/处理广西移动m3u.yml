name: Sync2 IPTV to Gitee

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤©å‡Œæ™¨2ç‚¹

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
    - name: ä¸‹è½½åŽŸå§‹IPTVæ–‡ä»¶
      run: |
        curl -s -o gxmobile.m3u https://raw.githubusercontent.com/Healer-sys/Home/main/iptv/gx.m3u
        curl -s -o gx.m3u https://raw.githubusercontent.com/Healer-sys/Home/main/iptv/gx.m3u

    - name: å¤„ç†IPTVæ–‡ä»¶ï¼ˆè¿‡æ»¤è¶…æ¸…å’Œ4Kèµ„æºï¼‰
      run: |
        # åˆ›å»ºè¿‡æ»¤è„šæœ¬
        cat > filter_channels.sh << 'EOF'
        #!/bin/bash
        
        input_file="gx.m3u"
        output_file="gxmobile_SD.m3u"
        
        # ä¸´æ—¶æ–‡ä»¶
        temp_file="temp_filtered.m3u"
        
        # æ¸…ç©ºè¾“å‡ºæ–‡ä»¶
        > "$output_file"
        
        # é€è¡Œå¤„ç†M3Uæ–‡ä»¶
        while IFS= read -r line
        do
            # å¦‚æžœæ˜¯EXTM3Uå¤´æˆ–ç©ºç™½è¡Œï¼Œç›´æŽ¥è¾“å‡º
            if [[ "$line" == "#EXTM3U" ]] || [[ -z "$line" ]]; then
                echo "$line" >> "$output_file"
                continue
            fi
            
            # å¦‚æžœæ˜¯é¢‘é“ä¿¡æ¯è¡Œï¼ˆåŒ…å«tvg-nameï¼‰
            if [[ "$line" == "#EXTINF"* ]]; then
                # æ£€æŸ¥æ˜¯å¦åŒ…å«"è¶…æ¸…"æˆ–"çº¯äº«4K"
                if [[ "$line" == *"è¶…æ¸…"* ]] || [[ "$line" == *"çº¯äº«4K"* ]]; then
                    # è·³è¿‡è¿™ä¸ªé¢‘é“ï¼ˆåŒ…æ‹¬ä¸‹ä¸€è¡Œçš„URLï¼‰
                    skip_next=true
                else
                    # ä¿ç•™è¿™ä¸ªé¢‘é“
                    echo "$line" >> "$output_file"
                    skip_next=false
                fi
            elif [[ "$skip_next" == true ]]; then
                # è·³è¿‡è¿™ä¸ªé¢‘é“çš„URLè¡Œ
                skip_next=false
            else
                # è¾“å‡ºURLè¡Œ
                echo "$line" >> "$output_file"
            fi
        done < "$input_file"
        
        echo "âœ… æ–‡ä»¶å¤„ç†å®Œæˆï¼š"
        echo "åŽŸå§‹æ–‡ä»¶è¡Œæ•°: $(wc -l < "$input_file")"
        echo "å¤„ç†åŽè¡Œæ•°: $(wc -l < "$output_file")"
        
        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä¸ºç©º
        if [[ ! -s "$output_file" ]]; then
            echo "âŒ è­¦å‘Šï¼šå¤„ç†åŽçš„æ–‡ä»¶ä¸ºç©ºï¼"
            exit 1
        fi
        EOF
        
        # æ‰§è¡Œè¿‡æ»¤è„šæœ¬
        chmod +x filter_channels.sh
        ./filter_channels.sh
        
        # éªŒè¯å¤„ç†ç»“æžœ
        echo "ðŸ” å¤„ç†ç»“æžœéªŒè¯ï¼š"
        grep -E "è¶…æ¸…|çº¯äº«4K" gxmobile_SD.m3u || echo "âœ… å·²æˆåŠŸè¿‡æ»¤è¶…æ¸…å’Œ4Kèµ„æº"
        grep -E "é«˜æ¸…|æ ‡æ¸…" gxmobile_SD.m3u | head -5 | sed 's/^/  ä¿ç•™é¢‘é“: /' || echo "âš ï¸ æœªæ‰¾åˆ°é«˜æ¸…æˆ–æ ‡æ¸…é¢‘é“"

    - name: æŽ¨é€åˆ°Gitee
      run: |
        # è®¾ç½®å˜é‡
        USER="tyrian9905"    # â† ç”¨æˆ·å
        REPO="iptv"        # â† ä»“åº“å
        TOKEN="a74325e9ecd2a8f505b8cd8d9b7138a0"      # â† Token
        
        # é…ç½®Git
        git config --global user.name "Auto Sync"
        git config --global user.email "auto@sync.com"
        
        # å…‹éš†ä»“åº“
        git clone https://oauth2:${TOKEN}@gitee.com/${USER}/${REPO}.git
        
        # è¿›å…¥ä»“åº“å¹¶æ›´æ–°æ–‡ä»¶
        cd ${REPO}
        
        # å¤åˆ¶å¤„ç†å‰çš„æ–‡ä»¶
        cp ../gxmobile.m3u ./
        
        # å¤åˆ¶å¤„ç†åŽçš„æ–‡ä»¶
        cp ../gxmobile_SD.m3u ./
        
        # æäº¤å¹¶æŽ¨é€
        git add gxmobile.m3u gxmobile_SD.m3u
        git commit -m "åŒæ­¥å¹¶è¿‡æ»¤é¢‘é“ $(date '+%Y-%m-%d %H:%M')
        - ä¿ç•™ï¼šé«˜æ¸…å’Œæ ‡æ¸…é¢‘é“
        - è¿‡æ»¤ï¼šè¶…æ¸…å’Œçº¯äº«4Ké¢‘é“"
        git push origin master
        
        echo "ðŸŽ‰ åŒæ­¥æˆåŠŸï¼"
        echo "åŽŸå§‹æ–‡ä»¶: https://gitee.com/${USER}/${REPO}/raw/master/gxmobile.m3u"
        echo "è¿‡æ»¤åŽæ–‡ä»¶: https://gitee.com/${USER}/${REPO}/raw/master/gxmobile_SD.m3u"
        echo ""
        echo "ðŸ“Š æ–‡ä»¶ä¿¡æ¯ï¼š"
        echo "gxmobile.m3u å¤§å°: $(du -h gxmobile.m3u | cut -f1)"
        echo "gxmobile_SD.m3u å¤§å°: $(du -h gxmobile_SD.m3u | cut -f1)"
