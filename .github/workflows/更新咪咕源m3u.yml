name: æ›´æ–°å’ªå’•æº

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  schedule:
  # åŒ—äº¬æ—¶é—´å‡Œæ™¨2ç‚¹ = UTCæ—¶é—´å‰ä¸€å¤©18ç‚¹
  - cron: '15 20 * * *'

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        persist-credentials: false
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests beautifulsoup4
    
    - name: Download and update M3U file
      run: |
        python << 'EOF'
        import requests
        import re
        from bs4 import BeautifulSoup
        from urllib.parse import urlparse
        
        def extract_ips_from_html(html_content):
            """
            ä»HTMLå†…å®¹ä¸­æå–IP/åŸŸåå’Œç«¯å£
            æ”¯æŒæ ¼å¼: IP:PORT, åŸŸå:PORT, IP:PORT/è·¯å¾„
            """
            ip_patterns = [
                # åŒ¹é… IP:PORT æ ¼å¼
                r'(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}:\d+)',
                # åŒ¹é… åŸŸå:PORT æ ¼å¼
                r'([a-zA-Z0-9][-a-zA-Z0-9]{0,62}(\.[a-zA-Z0-9][-a-zA-Z0-9]{0,62})+\.?:\d+)',
                # åŒ¹é… IP:PORT/è·¯å¾„ æ ¼å¼
                r'(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}:\d+[^<\s>]*)',
                # åŒ¹é… åŸŸå:PORT/è·¯å¾„ æ ¼å¼
                r'([a-zA-Z0-9][-a-zA-Z0-9]{0,62}(\.[a-zA-Z0-9][-a-zA-Z0-9]{0,62})+\.?:\d+[^<\s>]*)'
            ]
            
            all_addresses = []
            
            for pattern in ip_patterns:
                matches = re.findall(pattern, html_content)
                for match in matches:
                    # å¦‚æœåŒ¹é…ç»“æœæ˜¯å…ƒç»„ï¼ˆç”±äºåˆ†ç»„ï¼‰ï¼Œå–ç¬¬ä¸€ä¸ªå…ƒç´ 
                    if isinstance(match, tuple):
                        address = match[0]
                    else:
                        address = match
                    
                    # æ¸…ç†åœ°å€ï¼Œç§»é™¤å¤šä½™çš„ç©ºæ ¼å’Œç‰¹æ®Šå­—ç¬¦
                    address = address.strip()
                    # ç§»é™¤å¯èƒ½çš„å‰åå¼•å·
                    address = address.strip('"').strip("'").strip()
                    
                    # éªŒè¯åœ°å€æ ¼å¼
                    if ':' in address:
                        # åˆ†å‰²åœ°å€å’Œå¯èƒ½çš„è·¯å¾„
                        parts = address.split('/')[0]
                        if ':' in parts:
                            all_addresses.append(address)
            
            # å»é‡
            unique_addresses = []
            for addr in all_addresses:
                if addr not in unique_addresses:
                    unique_addresses.append(addr)
            
            return unique_addresses
        
        def clean_ip_address(ip_address):
            """
            æ¸…ç†IPåœ°å€ï¼Œç§»é™¤å¤šä½™éƒ¨åˆ†
            """
            # å¦‚æœåŒ…å«è·¯å¾„ï¼Œåªä¿ç•™IP:PORTéƒ¨åˆ†
            if '/' in ip_address:
                # æå–åè®®ã€åŸŸå/IPå’Œç«¯å£
                parsed = urlparse('http://' + ip_address.replace('://', '://'))
                hostname = parsed.hostname
                port = parsed.port
                
                if hostname and port:
                    return f"{hostname}:{port}"
                elif hostname:
                    return hostname
            
            return ip_address
        
        # 1. ä¸‹è½½åŸå§‹M3Uæ–‡ä»¶
        print("æ­£åœ¨ä¸‹è½½å’ªå’•æ¨¡æ¿...")
        m3u_url = "https://raw.githubusercontent.com/tyrian9905/iptv/refs/heads/main/å’ªå’•æ¨¡æ¿.m3u"
        response = requests.get(m3u_url)
        m3u_content = response.text
        
        # 2. è·å–IPåˆ—è¡¨
        print("æ­£åœ¨è·å–IPåˆ—è¡¨...")
        ip_url = "https://gxiptv.de5.net/list"
        try:
            ip_response = requests.get(ip_url, timeout=10)
            ip_response.raise_for_status()
            
            # æå–IPåœ°å€
            ip_list = extract_ips_from_html(ip_response.text)
            
            # æ¸…ç†IPåœ°å€
            cleaned_ips = [clean_ip_address(ip) for ip in ip_list]
            
            print(f"æ‰¾åˆ°åŸå§‹IPåˆ—è¡¨ ({len(ip_list)}ä¸ª): {ip_list}")
            print(f"æ¸…ç†åIPåˆ—è¡¨ ({len(cleaned_ips)}ä¸ª): {cleaned_ips}")
            
            # å–å‰3ä¸ª
            ip_list = cleaned_ips[:3]
            
        except Exception as e:
            print(f"è·å–IPåˆ—è¡¨å¤±è´¥: {e}")
            # å¦‚æœè·å–å¤±è´¥ï¼Œä½¿ç”¨ç¤ºä¾‹IP
            ip_list = ['219.149.247.15:8083', 'w.yyjn.top:3000', '110.155.78.12:7788']
            print(f"ä½¿ç”¨ç¤ºä¾‹IP: {ip_list}")
        
        # ç¡®ä¿è‡³å°‘æœ‰3ä¸ªIPï¼ˆå¦‚æœä¸è¶³ï¼Œç”¨ç©ºå­—ç¬¦ä¸²å¡«å……ï¼‰
        while len(ip_list) < 3:
            ip_list.append('')
        
        # 3. æ›¿æ¢IPå ä½ç¬¦
        print("æ­£åœ¨æ›¿æ¢IPå ä½ç¬¦...")
        print(f"ä½¿ç”¨çš„IP: {ip_list}")
        
        replacements = {
            '{ip_port1}': ip_list[0] if ip_list[0] else '',
            '{ip_port2}': ip_list[1] if ip_list[1] else '',
            '{ip_port3}': ip_list[2] if ip_list[2] else ''
        }
        
        for placeholder, ip in replacements.items():
            m3u_content = m3u_content.replace(placeholder, ip)
            print(f"æ›¿æ¢ {placeholder} -> {ip}")
        
        # 4. ä¿å­˜æ–‡ä»¶
        output_file = 'å’ªå’•æº.m3u'
        with open(output_file, 'w', encoding='utf-8') as f:
            f.write(m3u_content)
        
        print(f"æ–‡ä»¶å·²ä¿å­˜: {output_file}")

    - name: å¼€å§‹æ¨é€
      run: |
        # é…ç½®Git
        git config --global user.name "Auto Sync"
        git config --global user.email "auto@sync.com"
        USER="tyrian9905"
        REPO="iptv"
        
        # è·å–åŒ—äº¬æ—¶é—´
        export TZ='Asia/Shanghai'
        BEIJING_TIME=$(date '+%Y-%m-%d %H:%M:%S')
        
        # å…‹éš†ä»“åº“
        git clone https://oauth2:${{ secrets.GITEE_TOKEN }}@gitee.com/${USER}/${REPO}.git
        
        # è¿›å…¥ä»“åº“å¹¶æ›´æ–°æ–‡ä»¶
        cd ${REPO}
        
        # ç¡®ä¿ç›®å½•å­˜åœ¨
        mkdir -p iptv
        
        # å¤åˆ¶æ–‡ä»¶
        cp ../å’ªå’•æº.m3u ./ 2>/dev/null || true
        
        # æ·»åŠ dnsblockç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶
        #git add iptv/
        git add .
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
        if ! git diff --cached --quiet; then
          git commit -m "è‡ªåŠ¨åŒæ­¥æ–‡ä»¶ ${BEIJING_TIME}"
          git push origin master
          echo "âœ… æ–‡ä»¶å·²åŒæ­¥ï¼"
        else
          echo "âš ï¸ æ²¡æœ‰æ–‡ä»¶å˜æ›´ï¼Œè·³è¿‡æäº¤"
        fi
        
        echo "ğŸ‰ æ‰§è¡ŒæˆåŠŸï¼"
