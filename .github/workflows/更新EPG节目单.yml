name: 更新EPG节目单

on:
  workflow_dispatch:  # 手动触发
  schedule:
  # 北京时间凌晨2点 = UTC时间前一天18点
  - cron: '15 16,18,20,22,0,2,4,6,8,10,12,14 * * *'

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
        git config --global user.name "Auto Sync"
        git config --global user.email "auto@sync.com"
        
        USER="tyrian9905"
        REPO="work"
        BRANCH="main"
        
        # 步骤1：下载外部ppxml文件（带错误检查）
        wget -q https://epg.112114.xyz/pp.xml -O 1day112114_epg.xml

        # 步骤3：克隆CNB仓库（浅克隆）
        echo "克隆CNB仓库到临时目录..."
        git clone --depth 1 https://cnb:${{ secrets.CNB_TOKEN }}@cnb.cool/${USER}/${REPO}.git || {
          echo "错误：克隆CNB仓库失败"
          exit 1
        }
        
        # 步骤4：进入仓库目录并复制文件
        cd ${REPO} || exit 1
        mv 1day112114_epg.xml ./  # 确保文件在仓库根目录
        
        # 步骤5：拉取远程分支最新代码（避免冲突）
        echo "拉取远程${BRANCH}分支最新代码..."
        git pull origin ${BRANCH} -q --rebase || true
        
        # 步骤6：提交并推送（仅当有变更时）
        echo "检查文件变更..."
        if [ -n "$(git status --porcelain)" ]; then
          BEIJING_TIME=$(date +%Y%m%d%H%M%S)
          git add .
          git commit -m "自动同步 ${BEIJING_TIME}"
          git push origin ${BRANCH} || {
            echo "错误：推送失败，请检查CNB_TOKEN权限"
            exit 1
          }
        else
          echo "无文件变更，无需推送"
        fi
        
        echo "同步完成！"
