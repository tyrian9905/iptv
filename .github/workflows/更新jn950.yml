name: æ›´æ–°jn950ç›´æ’­æº

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  schedule:
    # æ¯å¤©UTCæ—¶é—´18:00å’Œ02:00æ‰§è¡Œï¼ˆåŒ—äº¬æ—¶é—´02:00å’Œ10:00ï¼‰
    #- cron: '0 2,10 * * *'
    - cron: '0 10 * * *'

jobs:
  process-tv-channels:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    # æ­¥éª¤1: æ£€å‡ºä»£ç 
    - uses: actions/checkout@v4
    
    # æ­¥éª¤2: è®¾ç½®Pythonç¯å¢ƒ
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    # æ­¥éª¤3: å®‰è£…ä¾èµ–
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install requests
    
    # æ­¥éª¤4: å¤„ç†ç”µè§†èŠ‚ç›®
    - name: å¤„ç†ç”µè§†èŠ‚ç›®æº
      run: |
        cat << 'EOF' > tv_processor.py
        import re
        import requests
        from urllib.parse import quote
        import subprocess
        import sys
        
        # ==================== é…ç½®å‚æ•° ====================
        SOURCE_URL = "https://raw.githubusercontent.com/jn950/live/refs/heads/main/tv/pllive.txt"
        EPG_URL = "https://gitee.com/taksssss/tv/raw/main/epg/51zmt.xml.gz"
        LOGO_BASE_URL = "https://gitee.com/tyrian9905/iptv/raw/master/tvlogo/"
        GROUP_FLAT = "MY9"
        
        # ==================== è¾…åŠ©å‡½æ•° ====================
        def check_tvlink_availability(tvlink):
            """æ£€æŸ¥TVé“¾æ¥æ˜¯å¦å¯ç”¨ï¼ˆåŸºäºtime_starttransferï¼‰"""
            try:
                # ä½¿ç”¨curlæ£€æŸ¥é“¾æ¥ä¼ è¾“æ—¶é—´
                cmd = ['curl', '-o', '/dev/null', '--connect-timeout', '1',
                       '-m', '1', '-s', '-w', '%{time_starttransfer}', tvlink]
                result = subprocess.run(cmd, capture_output=True, text=True)
                if result.returncode == 0:
                    time_starttransfer = result.stdout.strip()
                    # å¦‚æœtime_starttransferä¸ºç©ºæˆ–æ— æ³•è§£æä¸ºæµ®ç‚¹æ•°ï¼Œè§†ä¸ºå¤±è´¥
                    try:
                        transfer_time = float(time_starttransfer)
                        # å¦‚æœä¼ è¾“æ—¶é—´ä¸º0æˆ–å¤§äº0.15ç§’ï¼Œè§†ä¸ºä¸å¯ç”¨
                        if transfer_time == 0 or transfer_time > 0.99:
                            return False
                        return True
                    except ValueError:
                        return False
                return False
            except Exception:
                return False
        
        def normalize_tvname(tvname):
            """æ ‡å‡†åŒ–é¢‘é“åç§°"""
            # è½¬æ¢ä¸ºå¤§å†™
            tvname = tvname.upper()
            
            # ç§»é™¤ä¸éœ€è¦çš„å­—ç¬¦ä¸²
            characters_to_remove = [' ', '-', 'FHD', 'HD', 'SD', 'é«˜æ¸…', 'æ ‡æ¸…', 'è¶…æ¸…']
            for char in characters_to_remove:
                tvname = tvname.replace(char, '')
            
            return tvname
        
        def process_special_channels(tvname):
            """å¤„ç†ç‰¹æ®Šé¢‘é“åç§°"""
            display_name = tvname
            
            # 100.1: è¥¿è—å«è§†è—è¯­
            if "è¥¿è—å«è§†è—è¯­" in tvname:
                tvname = "è—è¯­å«è§†"
                display_name = "è—è¯­å«è§†"
            
            # 100.2: ç¬¬ä¸€è´¢ç»
            elif tvname == "ç¬¬ä¸€è´¢ç»":
                tvname = "ä¸œæ–¹è´¢ç»"
                display_name = "ä¸œæ–¹è´¢ç»"
            
            # 100.3: ä¸­å›½äº¤é€šé¢‘é“
            elif tvname == "ä¸­å›½äº¤é€šé¢‘é“":
                tvname = "ä¸­å›½äº¤é€š"
                display_name = "ä¸­å›½äº¤é€š"
            
            return tvname, display_name
        
        def process_cgtn_channels(tvname):
            """å¤„ç†CGTNé¢‘é“"""
            display_name = tvname
            
            # 100.5.1: CGTNè‹±è¯­
            if "CGTNè‹±è¯­" in tvname:
                tvname = "CGTN"
                display_name = "CGTN"
            
            # 100.5.2: é˜¿æ‹‰ä¼¯è¯­
            elif "é˜¿æ‹‰ä¼¯è¯­" in tvname:
                tvname = "CGTNé˜¿è¯­"
                display_name = "CGTNé˜¿æ‹‰ä¼¯è¯­"
            
            # 100.5.3: è¥¿ç­ç‰™è¯­
            elif "è¥¿ç­ç‰™è¯­" in tvname:
                tvname = "CGTNè¥¿è¯­"
                display_name = "CGTNè¥¿ç­ç‰™è¯­"
            
            return tvname, display_name
        
        def process_cctv_channels(tvname):
            """å¤„ç†CCTVé¢‘é“"""
            display_name = tvname
            
            # CCTVæ˜¾ç¤ºåç§°æ˜ å°„
            cctv_display_names = {
                "CCTV1": "CCTV-1 ç»¼åˆ",
                "CCTV2": "CCTV-2 è´¢ç»",
                "CCTV3": "CCTV-3 ç»¼è‰º",
                "CCTV4": "CCTV-4 ä¸­æ–‡å›½é™…",
                "CCTV5": "CCTV-5 ä½“è‚²",
                "CCTV6": "CCTV-6 ç”µå½±",
                "CCTV7": "CCTV-7 å›½é˜²å†›äº‹",
                "CCTV8": "CCTV-8 ç”µè§†å‰§",
                "CCTV9": "CCTV-9 çºªå½•",
                "CCTV11": "CCTV-11 æˆæ›²",
                "CCTV12": "CCTV-12 ç¤¾ä¼šä¸æ³•",
                "CCTV13": "CCTV-13 æ–°é—»",
                "CCTV14": "CCTV-14 å°‘å„¿",
                "CCTV15": "CCTV-15 éŸ³ä¹",
                "CCTV16": "CCTV-16 å¥¥æ—åŒ¹å…‹",
                "CCTV17": "CCTV-17 å†œä¸šå†œæ‘"
            }
            
            # 100.7.1: 3Dé¢‘é“
            if "3D" in tvname:
                tvname = "CCTV3D"
                display_name = "CCTV 3D"
            
            # 100.7.2: ç¾æ´²é¢‘é“
            elif "ç¾æ´²" in tvname or "AME" in tvname:
                tvname = "CCTV4ç¾æ´²"
                display_name = "CCTV-4 ç¾æ´²"
            
            # 100.7.3: æ¬§æ´²é¢‘é“
            elif "æ¬§æ´²" in tvname or "EUO" in tvname:
                tvname = "CCTV4æ¬§æ´²"
                display_name = "CCTV-4 æ¬§æ´²"
            
            # 100.7.4: 5+é¢‘é“
            elif "+" in tvname or "PLUS" in tvname:
                tvname = "CCTV5+"
                display_name = "CCTV-5+ ä½“è‚²èµ›äº‹"
            
            # 100.7.5: CCTV10
            elif "10" in tvname:
                tvname = "CCTV10"
                display_name = "CCTV-10 ç§‘æ•™"
            
            # 100.7.6: å…¶ä»–CCTVæ•°å­—é¢‘é“
            else:
                # ç§»é™¤0å¹¶æ·»åŠ HD
                modified_name = tvname.replace("0", "") + "HD"
                
                # ä½¿ç”¨æ­£åˆ™æå–CCTVæ•°å­—
                pattern = r"(CCTV\d{1,2})[^\d]"
                match = re.search(pattern, modified_name)
                
                if match:
                    tvname = match.group(1)
                    display_name = cctv_display_names.get(tvname, tvname)
            
            return tvname, display_name
        
        def build_logo_url(tvname):
            """æ„å»ºLogo URL"""
            # ç§»é™¤æ–œæ å¹¶ç¼–ç 
            safe_tvname = quote(tvname.replace("/", ""))
            return f"{LOGO_BASE_URL}{safe_tvname}.png"
        
        def write_channel_entry(file_obj, tvname, group_name, display_name, tvlink, logo_url):
            """å†™å…¥M3Ué¢‘é“æ¡ç›®"""
            # æ„å»ºEXTINFè¡Œ
            extinf_line = f'#EXTINF:-1 tvg-name="{tvname}" '
            extinf_line += f'tvg-logo="{logo_url}" '
            extinf_line += f'group-title="{group_name}",{display_name}'
            
            # å†™å…¥æ–‡ä»¶
            file_obj.write(f"{extinf_line}\n")
            file_obj.write(f"{tvlink}\n")
        
        def process_line(line, current_group_orig, current_group_cat):
            """å¤„ç†å•è¡Œæ•°æ®"""
            # 40: è·³è¿‡ç©ºç™½è¡Œ
            line = line.strip()
            if not line:
                return current_group_orig, current_group_cat, None
            
            # 50: åˆ†å‰²è¡Œå†…å®¹
            parts = line.split(',', 1)
            if len(parts) < 2:
                return current_group_orig, current_group_cat, None
            
            str1, str2 = parts[0].strip(), parts[1].strip()
            
            # 60: æ ¹æ®str2çš„å€¼å¤„ç†
            if not str2:
                # æƒ…å†µ1: str2ä¸ºç©ºï¼Œè·³è¿‡
                return current_group_orig, current_group_cat, None
            
            elif str2 == "#genre#":
                # æƒ…å†µ2: åˆ†ç»„è¡Œ
                return str1, current_group_cat, None
            
            else:
                # æƒ…å†µ3: é¢‘é“è¡Œ
                tvname = str1
                tvlink = str2
                
                # 70: è·³è¿‡4K/8Ké¢‘é“å’Œç‰¹å®šå«è§†é¢‘é“
                if ("4K" in tvname or "8K" in tvname or 
                    re.search(r"å«è§†[\d]", tvname)):
                    return current_group_orig, current_group_cat, None
                
                # 75: æ£€æŸ¥TVé“¾æ¥å¯ç”¨æ€§
                if not check_tvlink_availability(tvlink):
                    return current_group_orig, current_group_cat, None
                
                # 80: æ ‡å‡†åŒ–tvname
                tvname = normalize_tvname(tvname)
                
                # 90: display_nameåˆå§‹åŒ–ä¸ºtvname
                display_name = tvname
                
                # 100: æ ¹æ®tvnameå¤„ç†
                final_group_cat = current_group_cat
                final_tvname = tvname
                final_display_name = display_name
                
                # 100.1-100.3: å¤„ç†ç‰¹æ®Šé¢‘é“
                final_tvname, final_display_name = process_special_channels(final_tvname)
                
                # 100.5: å¤„ç†CETV/CGTN
                if "CETV" in final_tvname or "CGTN" in final_tvname:
                    final_group_cat = "å¤®è§†"
                    final_tvname, final_display_name = process_cgtn_channels(final_tvname)
                
                # 100.7: å¤„ç†CCTVé¢‘é“
                elif "CCTV" in final_tvname:
                    final_group_cat = "å¤®è§†"
                    final_tvname, final_display_name = process_cctv_channels(final_tvname)
                
                # æ„å»ºlogo URL
                logo_url = build_logo_url(final_tvname)
                
                return current_group_orig, current_group_cat, {
                    'tvname': final_tvname,
                    'display_name': final_display_name,
                    'tvlink': tvlink,
                    'group_orig': current_group_orig,
                    'group_cat': final_group_cat,
                    'logo_url': logo_url
                }
        
        def main():
            """ä¸»å¤„ç†å‡½æ•°"""
            try:
                # è·å–æºå†…å®¹
                print("æ­£åœ¨è·å–èŠ‚ç›®æºå†…å®¹...")
                response = requests.get(SOURCE_URL, timeout=10)
                response.raise_for_status()
                source_content = response.text
                
                # 20: ä»ç¬¬ä¸‰è¡Œå¼€å§‹å¤„ç†
                all_lines = source_content.splitlines()[2:]
                print(f"å…±è·å–åˆ° {len(all_lines)} è¡Œæ•°æ®")
                
                # 10: æ‰“å¼€è¾“å‡ºæ–‡ä»¶å¹¶å†™å…¥å¤´éƒ¨
                with (
                    open('MY9åŸç‰ˆ.m3u', 'w', encoding='utf-8') as f_orig,
                    open('MY9åˆ†èŠ‚ç›®.m3u', 'w', encoding='utf-8') as f_cat,
                    open('MY9æ— åˆ†ç»„.m3u', 'w', encoding='utf-8') as f_flat
                ):
                    # å†™å…¥M3Uå¤´éƒ¨
                    m3u_header = f'#EXTM3U x-tvg-url="{EPG_URL}"\n'
                    f_orig.write(m3u_header)
                    f_cat.write(m3u_header)
                    f_flat.write(m3u_header)
                    
                    # 30: åˆå§‹åŒ–åˆ†ç»„
                    group_orig = ""
                    group_cat = "å«è§†"
                    
                    processed_count = 0
                    skipped_count = 0
                    
                    # å¤„ç†æ¯ä¸€è¡Œ
                    for line in all_lines:
                        result = process_line(line, group_orig, group_cat)
                        group_orig, group_cat, channel_data = result
                        
                        if channel_data is None:
                            skipped_count += 1
                            continue
                        
                        # å†™å…¥æ–‡ä»¶
                        # 110: å†™å…¥åŸç‰ˆ
                        write_channel_entry(
                            f_orig,
                            channel_data['tvname'],
                            channel_data['group_orig'],
                            channel_data['display_name'],
                            channel_data['tvlink'],
                            channel_data['logo_url']
                        )
                        
                        # 120: å†™å…¥åˆ†ç±»ç‰ˆ
                        write_channel_entry(
                            f_cat,
                            channel_data['tvname'],
                            channel_data['group_cat'],
                            channel_data['display_name'],
                            channel_data['tvlink'],
                            channel_data['logo_url']
                        )
                        
                        # 130: å†™å…¥æ— åˆ†ç»„ç‰ˆ
                        write_channel_entry(
                            f_flat,
                            channel_data['tvname'],
                            GROUP_FLAT,
                            channel_data['display_name'],
                            channel_data['tvlink'],
                            channel_data['logo_url']
                        )
                        
                        processed_count += 1
                    
                    print(f"âœ… å¤„ç†å®Œæˆï¼å¤„ç†äº† {processed_count} ä¸ªé¢‘é“ï¼Œè·³è¿‡äº† {skipped_count} ä¸ªé¢‘é“")
                    
            except requests.RequestException as e:
                print(f"âŒ è·å–æºå†…å®¹å¤±è´¥: {e}")
                sys.exit(1)
            except Exception as e:
                print(f"âŒ å¤„ç†è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: {e}")
                sys.exit(1)
        
        if __name__ == "__main__":
            main()
        EOF
        
        # æ‰§è¡ŒPythonè„šæœ¬
        python tv_processor.py
    
    - name: å¼€å§‹æ¨é€
      if: success()  # åªæœ‰å‰é¢çš„æ­¥éª¤éƒ½æˆåŠŸæ‰æ‰§è¡Œæ¨é€
      run: |
        # é…ç½®Git
        git config --global user.name "Auto Sync"
        git config --global user.email "auto@sync.com"
        USER="tyrian9905"
        REPO="iptv"
        
        # è·å–åŒ—äº¬æ—¶é—´
        export TZ='Asia/Shanghai'
        BEIJING_TIME=$(date '+%Y-%m-%d %H:%M:%S')
        
        # å…‹éš†ä»“åº“
        git clone https://oauth2:${{ secrets.GITEE_TOKEN }}@gitee.com/${USER}/${REPO}.git
        
        # è¿›å…¥ä»“åº“å¹¶æ›´æ–°æ–‡ä»¶
        cd ${REPO}
        
        # ç¡®ä¿ç›®å½•å­˜åœ¨
        mkdir -p iptv
        
        # æ£€æŸ¥M3Uæ–‡ä»¶æ˜¯å¦ç”Ÿæˆ
        if [ ! -f "../MY9åŸç‰ˆ.m3u" ]; then
          echo "âŒ M3Uæ–‡ä»¶æœªç”Ÿæˆï¼Œè·³è¿‡æ¨é€"
          exit 0
        fi
        
        # å¤åˆ¶æ‰€æœ‰M3Uæ–‡ä»¶
        cp ../*.m3u ./ 2>/dev/null || true
        
        # æ·»åŠ ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶
        git add .
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
        if ! git diff --cached --quiet; then
          git commit -m "è‡ªåŠ¨åŒæ­¥æ–‡ä»¶ ${BEIJING_TIME}"
          git push origin master
          echo "âœ… æ–‡ä»¶å·²åŒæ­¥ï¼"
        else
          echo "âš ï¸ æ²¡æœ‰æ–‡ä»¶å˜æ›´ï¼Œè·³è¿‡æäº¤"
        fi
        
        echo "ğŸ‰ èŠ‚ç›®m3uæ›´æ–°æˆåŠŸï¼"
