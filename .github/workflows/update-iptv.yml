name: Update and Process IPTV Playlist

on:
  schedule:
    - cron: '0 2 * * *'  # 每天凌晨2点自动运行
  workflow_dispatch:      # 支持手动触发
  push:
    paths:
      - '.github/workflows/update-iptv.yml'

jobs:
  process-playlist:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          
      - name: Download original playlist
        run: |
          curl -s -o original.m3u https://raw.githubusercontent.com/Healer-sys/Home/refs/heads/main/iptv/gx.m3u
          
      - name: Process playlist (add tvg-id)
        run: |
          # 安装 Python（如果还没安装）
          python3 -c "
          import re
          
          with open('original.m3u', 'r', encoding='utf-8') as f:
              lines = f.readlines()
          
          output_lines = []
          for line in lines:
              line = line.rstrip('\n')
              # 匹配 #EXTINF 行
              if line.startswith('#EXTINF:'):
                  # 提取频道名称（最后一个逗号后面的部分）
                  if ',' in line:
                      # 找到最后一个逗号的位置
                      last_comma = line.rfind(',')
                      if last_comma != -1:
                          channel_name = line[last_comma + 1:].strip()
                          # 生成 tvg-id（去掉特殊字符，用下划线连接）
                          tvg_id = re.sub(r'[^\w\s]', '', channel_name)
                          tvg_id = re.sub(r'\s+', '_', tvg_id).lower()
                          # 在 #EXTINF 行后添加 tvg-id 属性
                          extinf_line = line
                          if 'tvg-id=' not in extinf_line:
                              # 在最后一个逗号前插入 tvg-id
                              insert_pos = extinf_line.rfind(',')
                              if insert_pos != -1:
                                  tvg_id_attr = f' tvg-id=\"{tvg_id}\"'
                                  extinf_line = extinf_line[:insert_pos] + tvg_id_attr + extinf_line[insert_pos:]
                          output_lines.append(extinf_line)
                          continue
              output_lines.append(line)
          
          # 写入新文件
          with open('processed.m3u', 'w', encoding='utf-8') as f:
              f.write('\n'.join(output_lines))
          "
          
      - name: Save processed playlist
        run: |
          # 创建 iptv 目录（如果不存在）
          mkdir -p iptv
          # 复制到指定位置
          cp processed.m3u iptv/gx.m3u
          
      - name: Commit and push changes
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          git add iptv/gx.m3u
          git diff --quiet && git diff --staged --quiet || {
            git commit -m "Update: Processed IPTV playlist $(date +'%Y-%m-%d %H:%M:%S')"
            git push
          }
