name: Update and Process IPTV Playlist

on:
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤©å‡Œæ™¨2ç‚¹è‡ªåŠ¨è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´10ç‚¹ï¼‰
  workflow_dispatch:      # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  push:
    paths:
      - '.github/workflows/update-iptv.yml'

jobs:
  process-playlist:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Download original playlist
        run: |
          curl -s -o original.m3u https://raw.githubusercontent.com/Healer-sys/Home/refs/heads/main/iptv/gx.m3u
          echo "ä¸‹è½½å®Œæˆ"
          
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          
      - name: Process playlist
        run: |
          echo "å¼€å§‹å¤„ç†M3Uæ–‡ä»¶..."
          python3 << 'EOF'
          import re
          
          # è¯»å–åŸå§‹æ–‡ä»¶
          with open('original.m3u', 'r', encoding='utf-8') as f:
              lines = f.readlines()
          
          output_lines = []
          for line in lines:
              line = line.rstrip('\n')
              
              # å¦‚æœæ˜¯ #EXTINF è¡Œ
              if line.startswith('#EXTINF:'):
                  # æ‰¾æœ€åä¸€ä¸ªé€—å·
                  if ',' in line:
                      last_comma = line.rfind(',')
                      if last_comma != -1:
                          channel_name = line[last_comma + 1:].strip()
                          
                          # å¦‚æœå·²ç»åŒ…å«tvg-idï¼Œè·³è¿‡
                          if 'tvg-id=' in line:
                              output_lines.append(line)
                              continue
                              
                          # ç”Ÿæˆtvg-idï¼šå»æ‰ç‰¹æ®Šå­—ç¬¦ï¼Œç©ºæ ¼å˜ä¸‹åˆ’çº¿ï¼Œè½¬å°å†™
                          tvg_id = re.sub(r'[^\w\s\u4e00-\u9fff]', '', channel_name)
                          tvg_id = re.sub(r'\s+', '_', tvg_id)
                          tvg_id = tvg_id.lower()
                          
                          # æ’å…¥åˆ°é€—å·å‰
                          new_line = line[:last_comma] + f' tvg-id="{tvg_id}"' + line[last_comma:]
                          output_lines.append(new_line)
                          continue
              
              # å…¶ä»–è¡Œç›´æ¥æ·»åŠ 
              output_lines.append(line)
          
          # ä¿å­˜å¤„ç†åçš„æ–‡ä»¶
          with open('processed.m3u', 'w', encoding='utf-8') as f:
              f.write('\n'.join(output_lines))
          
          print(f"å¤„ç†å®Œæˆï¼å…±å¤„ç†äº† {len(lines)} è¡Œ")
          EOF
          
      - name: Save to repository
        run: |
          # åˆ›å»ºç›®å½•
          mkdir -p iptv
          # ç§»åŠ¨æ–‡ä»¶
          mv processed.m3u iptv/gx_with_tvgid.m3u
          echo "æ–‡ä»¶å·²ä¿å­˜åˆ° iptv/gx_with_tvgid.m3u"
          
      - name: Commit and push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add iptv/
          git commit -m "ğŸ”„ è‡ªåŠ¨æ›´æ–°IPTVåˆ—è¡¨ $(date +'%Y-%m-%d %H:%M:%S')" || echo "æ²¡æœ‰å˜åŒ–éœ€è¦æäº¤"
          git push
