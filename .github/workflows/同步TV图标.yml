name: Sync TV Logos to Gitee

on:
  schedule:
    # æ¯å¤©UTCæ—¶é—´00:00è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´08:00ï¼‰
    - cron: '0 0 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches:
      - main

env:
  # ========== åœ¨è¿™é‡Œé…ç½®ä½ çš„å˜é‡ ==========
  GITEE_USERNAME: "tyrian9905"           # ä½ çš„Giteeç”¨æˆ·å
  GITEE_TOKEN: "a74325e9ecd2a8f505b8cd8d9b7138a0"   # ä½ çš„Giteeè®¿é—®ä»¤ç‰Œ
  # =======================================
  
  # å›ºå®šé…ç½®ï¼ˆä¸éœ€è¦ä¿®æ”¹ï¼‰
  GITHUB_SOURCE_URL: "https://raw.githubusercontent.com/fanmingming/live/main/tv/"
  TARGET_DIR: "tvlogo"

jobs:
  sync-logos:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout current repository
      uses: actions/checkout@v4
      
    - name: Sync PNG files from GitHub to Gitee
      env:
        # ä½¿ç”¨ä¸Šé¢å®šä¹‰çš„å˜é‡
        GITEE_USERNAME: ${{ env.GITEE_USERNAME }}
        GITEE_TOKEN: ${{ env.GITEE_TOKEN }}
        GITHUB_SOURCE_URL: ${{ env.GITHUB_SOURCE_URL }}
        TARGET_DIR: ${{ env.TARGET_DIR }}
      run: |
        # ============================================
        # TV Logo åŒæ­¥è„šæœ¬ (çº¯Shellç‰ˆæœ¬)
        # ============================================
        
        # é…ç½®å˜é‡
        SOURCE_URL="$GITHUB_SOURCE_URL"
        GITEE_USER="$GITEE_USERNAME"
        GITEE_TOKEN="$GITEE_TOKEN"
        TARGET_DIR="$TARGET_DIR"
        GITEE_REPO_URL="https://${GITEE_USER}:${GITEE_TOKEN}@gitee.com/tyrian9905/iptv.git"
        WORK_DIR="/tmp/tvlogos_work_$(date +%s)"
        
        # é¢œè‰²å®šä¹‰
        RED='\033[0;31m'
        GREEN='\033[0;32m'
        YELLOW='\033[1;33m'
        BLUE='\033[0;34m'
        NC='\033[0m' # No Color
        
        # è¾“å‡ºæ ·å¼å‡½æ•°
        log_info() {
          echo -e "${BLUE}[INFO]${NC} $1"
        }
        
        log_success() {
          echo -e "${GREEN}[SUCCESS]${NC} $1"
        }
        
        log_warning() {
          echo -e "${YELLOW}[WARNING]${NC} $1"
        }
        
        log_error() {
          echo -e "${RED}[ERROR]${NC} $1"
        }
        
        # éªŒè¯é…ç½®
        validate_config() {
          log_info "éªŒè¯é…ç½®..."
          
          if [ -z "$GITEE_USER" ]; then
            log_error "GITEE_USERNAME æœªè®¾ç½®"
            return 1
          fi
          
          if [ -z "$GITEE_TOKEN" ]; then
            log_error "GITEE_TOKEN æœªè®¾ç½®"
            return 1
          fi
          
          if [ "$GITEE_TOKEN" = "your_gitee_token_here" ]; then
            log_error "è¯·ä¿®æ”¹ GITEE_TOKEN ä¸ºä½ çš„å®é™…ä»¤ç‰Œ"
            return 1
          fi
          
          log_success "é…ç½®éªŒè¯é€šè¿‡"
          log_info "Giteeç”¨æˆ·å: $GITEE_USER"
          log_info "æºåœ°å€: $SOURCE_URL"
          return 0
        }
        
        # åˆ›å»ºä¸´æ—¶å·¥ä½œç›®å½•
        create_work_dir() {
          log_info "åˆ›å»ºä¸´æ—¶å·¥ä½œç›®å½•..."
          mkdir -p "$WORK_DIR"
          cd "$WORK_DIR" || {
            log_error "æ— æ³•è¿›å…¥å·¥ä½œç›®å½•"
            return 1
          }
        }
        
        # å…‹éš†Giteeä»“åº“
        clone_gitee_repo() {
          log_info "å…‹éš†Giteeä»“åº“..."
          echo "ä»“åº“URL: https://${GITEE_USER}:***@gitee.com/tyrian9905/iptv.git"
          
          if git clone "$GITEE_REPO_URL" iptv_repo 2>&1; then
            log_success "Giteeä»“åº“å…‹éš†æˆåŠŸ"
            return 0
          else
            log_error "Giteeä»“åº“å…‹éš†å¤±è´¥"
            return 1
          fi
        }
        
        # è·å–PNGæ–‡ä»¶åˆ—è¡¨
        get_png_files() {
          log_info "ä»GitHubè·å–PNGæ–‡ä»¶åˆ—è¡¨..."
          
          # å°è¯•ä»GitHub Pagesè·å–æ–‡ä»¶åˆ—è¡¨
          local html_content
          if ! html_content=$(curl -s -L --connect-timeout 30 "$SOURCE_URL"); then
            log_error "æ— æ³•è®¿é—®æºåœ°å€: $SOURCE_URL"
            return 1
          fi
          
          # ä½¿ç”¨grepæå–PNGæ–‡ä»¶å
          PNG_FILES=$(echo "$html_content" | grep -o 'href="[^"]*\.png"' | sed 's/href="//g' | sed 's/"//g' | sort | uniq)
          
          if [ -z "$PNG_FILES" ]; then
            log_warning "æœªèƒ½ä»HTMLæå–æ–‡ä»¶åˆ—è¡¨ï¼Œå°è¯•å¤‡é€‰æ–¹æ³•..."
            PNG_FILES=$(echo "$html_content" | grep -o '[a-zA-Z0-9_\-]*\.png' | sort | uniq)
          fi
          
          if [ -z "$PNG_FILES" ]; then
            log_warning "ä½¿ç”¨é¢„å®šä¹‰çš„æ–‡ä»¶åˆ—è¡¨..."
            # å¸¸è§çš„ç”µè§†å°logoæ–‡ä»¶å
            PNG_FILES="cctv1.png cctv2.png cctv3.png cctv4.png cctv5.png cctv5+.png cctv6.png cctv7.png cctv8.png cctv9.png cctv10.png cctv11.png cctv12.png cctv13.png cctv14.png cctv15.png cctv16.png cctv17.png cctv4k.png cctv8k.png cgtn.png åŒ—äº¬å«è§†.png æ¹–å—å«è§†.png æµ™æ±Ÿå«è§†.png æ±Ÿè‹å«è§†.png ä¸œæ–¹å«è§†.png å®‰å¾½å«è§†.png é‡åº†å«è§†.png å¹¿ä¸œå«è§†.png æ·±åœ³å«è§†.png é»‘é¾™æ±Ÿå«è§†.png å¤©æ´¥å«è§†.png å±±ä¸œå«è§†.png æ¹–åŒ—å«è§†.png å››å·å«è§†.png"
          fi
          
          FILE_COUNT=$(echo "$PNG_FILES" | wc -w)
          if [ "$FILE_COUNT" -eq 0 ]; then
            log_error "æœªæ‰¾åˆ°ä»»ä½•PNGæ–‡ä»¶"
            return 1
          fi
          
          log_success "æ‰¾åˆ° $FILE_COUNT ä¸ªPNGæ–‡ä»¶"
          echo "æ–‡ä»¶åˆ—è¡¨:"
          echo "$PNG_FILES" | tr ' ' '\n' | head -20
          if [ "$FILE_COUNT" -gt 20 ]; then
            echo "... ç­‰å…± $FILE_COUNT ä¸ªæ–‡ä»¶"
          fi
          
          echo "$PNG_FILES"
          return 0
        }
        
        # ä¸‹è½½PNGæ–‡ä»¶
        download_png_files() {
          local files="$1"
          local target_dir="$2"
          
          log_info "å¼€å§‹ä¸‹è½½PNGæ–‡ä»¶..."
          mkdir -p "$target_dir"
          
          DOWNLOAD_COUNT=0
          FAILED_COUNT=0
          TOTAL_FILES=$(echo "$files" | wc -w)
          CURRENT=0
          
          for file in $files; do
            CURRENT=$((CURRENT + 1))
            # æ¸…ç†æ–‡ä»¶å
            clean_file=$(echo "$file" | sed 's|^\./||')
            url="${SOURCE_URL}${clean_file}"
            output_path="${target_dir}/${clean_file}"
            
            echo -ne "[$CURRENT/$TOTAL_FILES] ä¸‹è½½: $clean_file ... "
            
            # ä½¿ç”¨curlä¸‹è½½æ–‡ä»¶
            if curl -s -L -o "$output_path" "$url" --connect-timeout 30 --max-time 60; then
              # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æœ‰æ•ˆ
              if [ -s "$output_path" ]; then
                file_size=$(stat -c%s "$output_path" 2>/dev/null || stat -f%z "$output_path" 2>/dev/null)
                echo -e "${GREEN}âœ“${NC} ($file_size bytes)"
                ((DOWNLOAD_COUNT++))
              else
                echo -e "${YELLOW}âš  ç©ºæ–‡ä»¶${NC}"
                rm -f "$output_path"
                ((FAILED_COUNT++))
              fi
            else
              echo -e "${RED}âœ— å¤±è´¥${NC}"
              ((FAILED_COUNT++))
            fi
          done
          
          log_info "ä¸‹è½½ç»Ÿè®¡: $DOWNLOAD_COUNT æˆåŠŸ, $FAILED_COUNT å¤±è´¥"
          echo "$DOWNLOAD_COUNT"
        }
        
        # Gité…ç½®å’Œæäº¤
        git_commit_and_push() {
          local repo_path="$1"
          local target_dir="$2"
          local downloaded_count="$3"
          
          cd "$repo_path" || {
            log_error "æ— æ³•è¿›å…¥ä»“åº“ç›®å½•"
            return 1
          }
          
          # é…ç½®Gitç”¨æˆ·
          log_info "é…ç½®Gitç”¨æˆ·ä¿¡æ¯..."
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜æ›´
          if git diff-index --quiet HEAD -- 2>/dev/null; then
            log_info "æ²¡æœ‰æ–‡ä»¶å˜æ›´ï¼Œè·³è¿‡æäº¤"
            return 0
          fi
          
          # æ·»åŠ æ–‡ä»¶
          log_info "æ·»åŠ æ–‡ä»¶åˆ°Git..."
          if git add "$target_dir/" 2>&1; then
            log_success "æ–‡ä»¶æ·»åŠ æˆåŠŸ"
          else
            log_error "æ·»åŠ æ–‡ä»¶å¤±è´¥"
            return 1
          fi
          
          # æäº¤
          COMMIT_TIME=$(date '+%Y-%m-%d %H:%M:%S')
          COMMIT_MESSAGE="ğŸ¤– TV Logoè‡ªåŠ¨åŒæ­¥

åŒæ­¥æ—¶é—´: $COMMIT_TIME
åŒæ­¥æ–‡ä»¶æ•°: $downloaded_count
æºåœ°å€: $SOURCE_URL

ç”±GitHub Actionsè‡ªåŠ¨åŒæ­¥"
          
          log_info "æäº¤æ›´æ”¹..."
          if git commit -m "$COMMIT_MESSAGE" 2>&1; then
            log_success "æäº¤æˆåŠŸ"
          else
            log_error "æäº¤å¤±è´¥"
            return 1
          fi
          
          # æ¨é€
          log_info "æ¨é€åˆ°Giteeä»“åº“..."
          if git push origin main 2>&1; then
            log_success "æ¨é€æˆåŠŸ"
            return 0
          else
            log_warning "æ¨é€å¤±è´¥ï¼Œå°è¯•å¼ºåˆ¶æ¨é€..."
            if git push origin main --force 2>&1; then
              log_success "å¼ºåˆ¶æ¨é€æˆåŠŸ"
              return 0
            else
              log_error "æ¨é€å®Œå…¨å¤±è´¥"
              return 1
            fi
          fi
        }
        
        # ä¸»å‡½æ•°
        main() {
          echo "========================================"
          log_info "å¼€å§‹TV LogoåŒæ­¥ä»»åŠ¡"
          echo "========================================"
          log_info "é…ç½®ä¿¡æ¯:"
          log_info "- Giteeç”¨æˆ·å: $GITEE_USER"
          log_info "- æºåœ°å€: $SOURCE_URL"
          log_info "- ç›®æ ‡ç›®å½•: $TARGET_DIR"
          echo ""
          
          # éªŒè¯é…ç½®
          if ! validate_config; then
            exit 1
          fi
          
          # 1. åˆ›å»ºå·¥ä½œç›®å½•
          if ! create_work_dir; then
            exit 1
          fi
          
          # 2. å…‹éš†Giteeä»“åº“
          if ! clone_gitee_repo; then
            log_error "è¯·æ£€æŸ¥:"
            log_error "1. GITEE_TOKENæ˜¯å¦æ­£ç¡®"
            log_error "2. ä»¤ç‰Œæ˜¯å¦æœ‰ä»“åº“è®¿é—®æƒé™"
            log_error "3. Giteeä»“åº“æ˜¯å¦å­˜åœ¨"
            exit 1
          fi
          
          # è¿›å…¥ä»“åº“ç›®å½•
          cd iptv_repo || exit 1
          
          # 3. è·å–PNGæ–‡ä»¶åˆ—è¡¨
          PNG_FILES=$(get_png_files)
          if [ $? -ne 0 ]; then
            exit 1
          fi
          
          # 4. ä¸‹è½½æ–‡ä»¶
          DOWNLOAD_COUNT=$(download_png_files "$PNG_FILES" "$TARGET_DIR")
          
          # 5. Gitæ“ä½œ
          if [ "$DOWNLOAD_COUNT" -gt 0 ]; then
            if git_commit_and_push "$(pwd)" "$TARGET_DIR" "$DOWNLOAD_COUNT"; then
              echo ""
              echo "========================================"
              log_success "ğŸ‰ TV LogoåŒæ­¥ä»»åŠ¡å®Œæˆï¼"
              echo "========================================"
              log_info "åŒæ­¥ç»Ÿè®¡:"
              log_info "- å°è¯•ä¸‹è½½æ–‡ä»¶: $(echo "$PNG_FILES" | wc -w)"
              log_info "- æˆåŠŸä¸‹è½½æ–‡ä»¶: $DOWNLOAD_COUNT"
              log_info "- ç›®æ ‡ä»“åº“: https://gitee.com/tyrian9905/iptv"
              log_info "- ç›®æ ‡ç›®å½•: $TARGET_DIR"
              log_info "- æŸ¥çœ‹ç»“æœ: https://gitee.com/tyrian9905/iptv/tree/main/$TARGET_DIR"
              echo ""
            else
              log_error "åŒæ­¥ä»»åŠ¡å®Œæˆä½†Gitæ“ä½œå¤±è´¥"
              exit 1
            fi
          else
            log_warning "æ²¡æœ‰æˆåŠŸä¸‹è½½ä»»ä½•æ–‡ä»¶ï¼Œè·³è¿‡æäº¤"
          fi
          
          # 6. æ¸…ç†å·¥ä½œç›®å½•ï¼ˆå¯é€‰ï¼‰
          echo ""
          log_info "å·¥ä½œç›®å½•: $WORK_DIR"
          log_info "ä»»åŠ¡ç»“æŸæ—¶é—´: $(date)"
        }
        
        # æ‰§è¡Œä¸»å‡½æ•°
        echo "========================================"
        echo "TV LogoåŒæ­¥è„šæœ¬å¼€å§‹æ‰§è¡Œ"
        echo "========================================"
        
        if main; then
          echo "========================================"
          log_success "è„šæœ¬æ‰§è¡Œå®Œæˆ"
          echo "========================================"
          exit 0
        else
          echo "========================================"
          log_error "è„šæœ¬æ‰§è¡Œå¤±è´¥"
          echo "========================================"
          exit 1
        fi
        
    - name: Success Notification
      if: success()
      run: |
        echo "âœ… TV LogoåŒæ­¥ä»»åŠ¡æˆåŠŸå®Œæˆï¼"
        echo ""
        echo "ğŸ“Š åŒæ­¥ç»Ÿè®¡:"
        echo "-----------------------------"
        echo "â€¢ æºåœ°å€: https://raw.githubusercontent.com/fanmingming/live/main/tv/"
        echo "â€¢ ç›®æ ‡åœ°å€: https://gitee.com/tyrian9905/iptv/tree/main/tvlogo"
        echo "â€¢ ä¸‹æ¬¡è¿è¡Œ: æ˜å¤©UTC 00:00 (åŒ—äº¬æ—¶é—´08:00)"
        echo "â€¢ æŸ¥çœ‹æ—¥å¿—: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        
    - name: Failure Notification
      if: failure()
      run: |
        echo "âŒ TV LogoåŒæ­¥ä»»åŠ¡å¤±è´¥ï¼"
        echo ""
        echo "ğŸ” é—®é¢˜æ’æŸ¥:"
        echo "-----------------------------"
        echo "1. æ£€æŸ¥GITEE_TOKENæ˜¯å¦æ­£ç¡®é…ç½®"
        echo "2. æ£€æŸ¥GITEE_USERNAMEæ˜¯å¦æ­£ç¡®"
        echo "3. éªŒè¯æºåœ°å€æ˜¯å¦å¯è®¿é—®:"
        echo "   curl -I https://raw.githubusercontent.com/fanmingming/live/main/tv/"
        echo "4. æ£€æŸ¥Giteeä»“åº“æ˜¯å¦æœ‰å†™å…¥æƒé™"
        echo "5. æŸ¥çœ‹è¯¦ç»†æ—¥å¿—è·å–æ›´å¤šä¿¡æ¯"
        echo ""
        echo "ğŸ“‹ å½“å‰é…ç½®:"
        echo "- GITEE_USERNAME: ${{ env.GITEE_USERNAME }}"
        echo "- GITEE_TOKEN: $(if [ -n '${{ env.GITEE_TOKEN }}' ]; then echo 'å·²è®¾ç½®'; else echo 'æœªè®¾ç½®'; fi)"
